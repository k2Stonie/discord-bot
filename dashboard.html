<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AFFILIATE BOT Dashboard - UPDATED v2.0 - {{ timestamp }}</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Version: 3.0 - Template Selection System -->
    <script>
        // Force cache refresh
        if (performance.navigation.type === 1) {
            window.location.reload(true);
        }
        // Add timestamp to force cache refresh
        document.addEventListener('DOMContentLoaded', function() {
            const timestamp = new Date().getTime();
            console.log('Page loaded at:', timestamp);
        });
    </script>
    <style>
        :root {
            --primary-color: #8b5cf6;
            --secondary-color: #7c3aed;
            --accent-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1e1e3f;
            --bg-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --border-color: #2d2d44;
            --border-light: #3f3f5a;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --green-accent: #10b981;
            --yellow-accent: #f59e0b;
            --blue-accent: #3b82f6;
        }

        [data-theme="dark"] {
            --primary-color: #8b5cf6;
            --secondary-color: #7c3aed;
            --accent-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1e1e3f;
            --bg-gradient: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            --border-color: #2d2d44;
            --border-light: #3f3f5a;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.3);
            --purple-gradient: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            --green-accent: #10b981;
            --yellow-accent: #f59e0b;
            --blue-accent: #3b82f6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: var(--bg-primary);
            border-radius: 20px;
            padding: 25px 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border-color);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .logo::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            border-radius: 15px;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 10px;
            position: relative;
            z-index: 1;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 6px;
        }

        .logo-icon::after {
            content: '';
            position: absolute;
            top: 12px;
            left: 12px;
            right: 12px;
            bottom: 12px;
            background: white;
            border-radius: 3px;
        }

        .header-text h1 {
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 2.2rem;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header-text p {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 400;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50px;
            padding: 10px 20px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            font-size: 14px;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .theme-icon {
            font-size: 18px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .status.online {
            background: rgba(16, 185, 129, 0.2);
            border-color: var(--green-accent);
            color: var(--green-accent);
        }
        
        .status.offline {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--yellow-accent);
            color: var(--yellow-accent);
        }

        .tabs {
            display: flex;
            background: var(--bg-primary);
            border-radius: 20px 20px 0 0;
            margin-bottom: 0;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            border-bottom: none;
        }

        .tab {
            flex: 1;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .tab:hover {
            background: rgba(102, 126, 234, 0.05);
            color: var(--text-primary);
        }
        
        .tab-content {
            background: var(--bg-primary);
            border-radius: 0 0 20px 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            min-height: 600px;
            border: 1px solid var(--border-color);
            border-top: none;
        }

        .tab-panel {
            display: none;
        }

        .tab-panel.active {
            display: block;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-light);
        }

        .card h3 {
            color: var(--text-primary);
            margin-bottom: 25px;
            font-size: 1.4rem;
            font-weight: 600;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }

        .btn {
            background: var(--purple-gradient);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.4);
            background: linear-gradient(135deg, #9f7aea 0%, #8b5cf6 100%);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--green-accent) 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #34d399 0%, var(--green-accent) 100%);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--yellow-accent) 0%, #d97706 100%);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #fbbf24 0%, var(--yellow-accent) 100%);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color) 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #f87171 0%, var(--danger-color) 100%);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--blue-accent) 0%, #2563eb 100%);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #60a5fa 0%, var(--blue-accent) 100%);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .info-item {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }
        
        .info-item .label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .info-item .value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 5px;
        }
        
        .role-dm-item {
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            border-left: 4px solid var(--primary-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }

        .role-dm-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }
        
        .role-dm-item h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .role-dm-item p {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .role-dm-item .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .role-dm-item .actions .btn {
            width: auto;
            padding: 8px 16px;
            font-size: 12px;
        }
        
        .campaign-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .campaign-item h4 {
            color: #4a5568;
            margin-bottom: 8px;
        }
        
        .campaign-item p {
            color: #718096;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .alert.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }
        
        .alert.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }
        
        .hidden {
            display: none;
        }

        .input-with-emoji {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input-with-emoji input {
            flex: 1;
        }

        .emoji-picker-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            min-width: 45px;
        }

        .emoji-picker-btn:hover {
            background: var(--bg-tertiary);
            transform: scale(1.05);
        }

        .emoji-selection {
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
        }

        .emoji-selection .input-with-emoji {
            margin-bottom: 10px;
        }

        .emoji-picker-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-height: 300px;
            overflow: hidden;
            display: none;
        }

        .emoji-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
        }

        .emoji-tab {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 600;
        }

        .emoji-tab.active {
            background: var(--primary-color);
            color: white;
        }

        .emoji-tab:hover:not(.active) {
            background: var(--bg-tertiary);
        }

        .emoji-picker-content {
            max-height: 250px;
            overflow-y: auto;
        }

        .emoji-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px;
        }

        .emoji-item {
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            min-height: 40px;
        }

        .emoji-item:hover {
            background: var(--bg-tertiary);
            transform: scale(1.1);
        }

        .server-emoji {
            width: 24px;
            height: 24px;
            object-fit: contain;
        }

        .emoji-name {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .template-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
            text-align: center;
        }

        .template-preview h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .template-preview p {
            color: var(--text-secondary);
            margin-bottom: 15px;
        }

            .template-preview .preview-button {
                background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 8px;
                font-weight: 600;
                cursor: default;
            }

            .preview-button-primary {
                background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
            }

            .preview-button-secondary {
                background: linear-gradient(135deg, #4f545c 0%, #3c4147 100%);
            }

            .preview-button-success {
                background: linear-gradient(135deg, #3ba55c 0%, #2d7d46 100%);
            }

            .preview-button-danger {
                background: linear-gradient(135deg, #ed4245 0%, #c03c3e 100%);
            }

            .preview-button-blurple {
                background: linear-gradient(135deg, #5865f2 0%, #4752c4 100%);
            }

            /* Channel Autocomplete Styles */
            .autocomplete-container {
                position: relative;
                display: inline-block;
                width: 100%;
            }

            .autocomplete-suggestions {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--bg-primary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                box-shadow: var(--shadow-lg);
                z-index: 1000;
                max-height: 200px;
                overflow-y: auto;
                display: none;
            }

            .autocomplete-suggestion {
                padding: 10px 15px;
                cursor: pointer;
                border-bottom: 1px solid var(--border-color);
                transition: background-color 0.2s ease;
            }

            .autocomplete-suggestion:hover {
                background: var(--bg-secondary);
            }

            .autocomplete-suggestion:last-child {
                border-bottom: none;
            }

            .autocomplete-suggestion .channel-name {
                font-weight: 600;
                color: var(--text-primary);
            }

            .autocomplete-suggestion .channel-id {
                font-size: 12px;
                color: var(--text-secondary);
                margin-left: 8px;
            }


        .section-title {
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 40px;
            font-weight: 700;
            border-bottom: 3px solid var(--border-color);
            padding-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 30px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border-radius: 2px;
        }

        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 768px) {
            .two-column {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-direction: column;
            }
        }

        /* Bot Personalizer Styles */
        .bot-personalizer-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .personalizer-header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .personalizer-description {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 20px 0;
        }

        .discord-limits-info {
            margin: 20px 0;
            padding: 15px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
        }

        .limit-warning {
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .limit-warning ul {
            margin: 8px 0 0 20px;
            padding: 0;
        }

        .limit-warning li {
            margin: 4px 0;
            color: var(--text-secondary);
        }

        .bot-status-toggle {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        .personalizer-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--bg-tertiary);
        }

        .personalizer-tab {
            background: none;
            border: none;
            padding: 15px 25px;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .personalizer-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .personalizer-tab:hover:not(.active) {
            color: var(--text-primary);
        }

        .ai-badge {
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .personalizer-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            align-items: start;
        }

        .bot-customization {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow-lg);
        }

        .avatar-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .avatar-preview {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-placeholder {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .update-avatar-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0 auto;
        }

        .update-avatar-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .upload-icon {
            font-size: 1.2rem;
        }

        .bot-settings .form-group {
            margin-bottom: 25px;
        }

        .bot-settings .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }

        .bot-settings .form-group input,
        .bot-settings .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--bg-tertiary);
            border-radius: 12px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .bot-settings .form-group input:focus,
        .bot-settings .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .save-changes-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .save-changes-btn:hover {
            background: #7c3aed;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .bot-preview {
            position: sticky;
            top: 20px;
        }

        .preview-card {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 30px;
            box-shadow: var(--shadow-lg);
            border: 2px solid var(--bg-tertiary);
        }

        .preview-card h3 {
            color: var(--text-primary);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.2rem;
        }

        .bot-preview-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .preview-avatar {
            position: relative;
        }

        .preview-avatar-img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .preview-avatar-placeholder {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .preview-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-status {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid var(--bg-card);
        }

        .preview-status.online {
            background: #22c55e;
        }

        .preview-status.idle {
            background: #f59e0b;
        }

        .preview-status.dnd {
            background: #ef4444;
        }

        .preview-status.offline {
            background: #6b7280;
        }

        .preview-info {
            flex: 1;
        }

        .preview-name {
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .preview-bot-tag {
            background: #5865f2;
            color: white;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
            margin-bottom: 8px;
        }

        .preview-activity {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        @media (max-width: 1024px) {
            .personalizer-content {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            .bot-preview {
                position: static;
            }
        }

        /* Quick DM Styles */
        .quick-dm-section {
            margin-top: 30px;
            width: 100%;
            clear: both;
        }

        .quick-dm-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .quick-dm-actions .btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: #7c3aed;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
        }

        .btn-icon {
            font-size: 1.1rem;
        }

        .quick-dm-status {
            margin-top: 20px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
        }

        .status-content {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .status-icon {
            font-size: 1.5rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-text {
            flex: 1;
        }

        .status-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .status-details {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #7c3aed);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .quick-dm-results {
            margin-top: 20px;
            padding: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .results-header h4 {
            margin: 0;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .results-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .result-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background: var(--bg-tertiary);
        }

        .result-item.success {
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid #22c55e;
        }

        .result-item.error {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #ef4444;
        }

        .result-item.info {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid #3b82f6;
        }

        .result-icon {
            font-size: 1.2rem;
        }

        .result-text {
            color: var(--text-primary);
        }

        .result-text strong {
            color: var(--primary-color);
        }

        /* AI Analytics Styles */
        .analytics-overview {
            margin-bottom: 30px;
        }

        .analytics-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 12px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .analytics-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .analytics-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .analytics-item-info {
            flex: 1;
        }

        .analytics-item-title {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .analytics-item-url {
            font-size: 0.8rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .analytics-item-stats {
            text-align: right;
        }

        .analytics-item-count {
            font-weight: bold;
            color: var(--primary-color);
        }

        .analytics-item-unique {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .insights-container {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }

        .insight-item {
            padding: 12px;
            margin-bottom: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }

        .insight-type {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .insight-data {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .insight-confidence {
            font-size: 0.8rem;
            color: var(--primary-color);
            margin-top: 5px;
        }

        .activity-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 6px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .activity-icon {
            margin-right: 10px;
            font-size: 1.2rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-user {
            font-weight: 500;
            color: var(--text-primary);
        }

        .activity-action {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-left: 10px;
        }

        .analytics-export {
            margin-top: 30px;
        }

        .export-actions {
            display: flex;
            gap: 15px;
        }

        .btn-icon {
            margin-right: 8px;
        }

        /* Emoji Picker Styles */
        .emoji-selection {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .emoji-picker-btn {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }
        
        .emoji-picker-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.05);
        }
        
        .emoji-picker-container {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow: hidden;
        }
        
        .emoji-tabs {
            display: flex;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
        }
        
        .emoji-tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .emoji-tab.active {
            background: var(--primary-color);
            color: white;
        }
        
        .emoji-tab:hover:not(.active) {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .emoji-picker-content {
            padding: 15px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 8px;
        }
        
        .emoji-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 40px;
        }
        
        .emoji-btn:hover {
            background: var(--primary-color);
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .server-emoji-btn img {
            width: 20px;
            height: 20px;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-icon"></div>
                </div>
                <div class="header-text">
                    <h1>AFFILIATE BOT</h1>
                    <p>Professional Discord Marketing Dashboard</p>
                </div>
            </div>
            <div class="header-right">
                <div class="status" id="botStatus">
                    {% if status.running %}üü¢ Online{% else %}üî¥ Offline{% endif %}
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">
                    <span class="theme-icon">üåô</span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Overview</button>
            <button class="tab" onclick="switchTab('personalizer')">üé® Bot Personalizer</button>
            <button class="tab" onclick="switchTab('getnow')">üéØ Get Now Buttons</button>
            <button class="tab" onclick="switchTab('roledms')">üí¨ Role DMs</button>
            <button class="tab" onclick="switchTab('marketing')">üì¢ Marketing</button>
            <button class="tab" onclick="switchTab('leads')">üî• Leads</button>
            <button class="tab" onclick="switchTab('analytics')">ü§ñ AI Analytics</button>
            <button class="tab" onclick="switchTab('settings')">‚öôÔ∏è Settings</button>
        </div>

        <div class="tab-content">
            <!-- Overview Tab -->
            <div id="overview" class="tab-panel active">
                <h2 class="section-title">Bot Overview</h2>
                <div class="grid">
                    <div class="card">
                        <h3>üìä Bot Status</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="label">Servers</div>
                                <div class="value" id="serverCount">{{ status.guilds|length }}</div>
                    </div>
                            <div class="info-item">
                                <div class="label">Commands</div>
                                <div class="value" id="commandCount">{{ status.commands|length }}</div>
                    </div>
                            <div class="info-item">
                                <div class="label">Last Sync</div>
                                <div class="value" id="lastSync">
                                    {% if status.last_sync %}
                                        {{ "%.0f"|format(status.last_sync) }}
                                    {% else %}
                                        Never
                                    {% endif %}
                    </div>
                </div>
                        </div>
                        <button class="btn btn-success" onclick="syncCommands()">üîÑ Sync Commands</button>
                    </div>
                    
                <div class="card">
                    <h3>üìà Quick Stats</h3>
                        <div class="info-grid">
                            <div class="info-item">
                                <div class="label">Active DMs</div>
                                <div class="value" id="activeDMs">0</div>
                        </div>
                            <div class="info-item">
                                <div class="label">Get Now Buttons</div>
                                <div class="value" id="getNowButtons">0</div>
                        </div>
                            <div class="info-item">
                                <div class="label">Active Campaigns</div>
                                <div class="value" id="activeCampaigns">0</div>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
            
            <!-- Bot Personalizer Tab -->
            <div id="personalizer" class="tab-panel">
                <div class="bot-personalizer-container">
                    <div class="personalizer-header">
                        <h2 class="section-title">Bot Personalizer</h2>
                        <p class="personalizer-description">Make your bot really special by changing its username, avatar, activity and backstory.</p>
                        <div class="discord-limits-info">
                            <div class="limit-warning">
                                <strong>‚ö†Ô∏è Discord API Limits:</strong>
                                <ul>
                                    <li>Username changes: 2 per hour</li>
                                    <li>Avatar changes: No limit</li>
                                    <li>Status/Activity: No limit</li>
                                </ul>
                            </div>
                        </div>
                        <div class="bot-status-toggle">
                            <span class="status-label">Active</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="botActiveToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="personalizer-tabs">
                        <button class="personalizer-tab active" onclick="switchPersonalizerTab('basics')">Basics</button>
                        <button class="personalizer-tab" onclick="switchPersonalizerTab('backstory')">
                            Backstory 
                            <span class="ai-badge">AI</span>
                    </button>
                    </div>
                    
                    <div class="personalizer-content">
                        <div class="personalizer-main">
                            <div class="bot-customization">
                                <div class="avatar-section">
                                    <div class="avatar-preview" id="avatarPreview">
                                        <div class="avatar-placeholder" id="avatarPlaceholder">BOT</div>
                                        <img id="avatarImage" style="display: none;" alt="Bot Avatar">
                                    </div>
                                    <button type="button" class="update-avatar-btn" onclick="document.getElementById('avatarUpload').click()">
                                        <span class="upload-icon">üì∑</span>
                                        Update Image
                                    </button>
                                    <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
                                </div>
                                
                                <div class="bot-settings">
                                    <div class="form-group">
                                        <label for="botName">Bot name</label>
                                        <input type="text" id="botName" placeholder="Enter bot name" value="TWLV'S EYES">
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="botStatus">Bot status</label>
                                        <select id="botStatus">
                                            <option value="online" selected>Online</option>
                                            <option value="idle">Idle</option>
                                            <option value="dnd">Do Not Disturb</option>
                                            <option value="offline">Offline</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="activityType">Activity Type</label>
                                        <select id="activityType">
                                            <option value="watching" selected>Watching</option>
                                            <option value="playing">Playing</option>
                                            <option value="listening">Listening to</option>
                                            <option value="streaming">Streaming</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label for="activityText">Activity text</label>
                                        <input type="text" id="activityText" placeholder="Enter activity text" value="PLEBS">
                                    </div>
                                    
                                    <button type="button" class="save-changes-btn" onclick="saveBotCustomization()">
                                        Save Changes
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bot-preview">
                            <div class="preview-card">
                                <h3>YOUR PERSONALIZED BOT</h3>
                                <div class="bot-preview-content">
                                    <div class="preview-avatar">
                                        <div class="preview-avatar-img" id="previewAvatar">
                                            <div class="preview-avatar-placeholder">BOT</div>
                                        </div>
                                        <div class="preview-status" id="previewStatus"></div>
                                    </div>
                                    <div class="preview-info">
                                        <div class="preview-name" id="previewName">TWLV'S EYES</div>
                                        <div class="preview-bot-tag">‚úì BOT</div>
                                        <div class="preview-activity" id="previewActivity">Watching PLEBS</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Get Now Buttons Tab -->
            <div id="getnow" class="tab-panel">
                <h2 class="section-title">üéØ Get Now Button Management</h2>
                <div class="two-column">
                    <div class="card">
                        <h3>‚ûï Create Get Now Button</h3>
                        <form id="getNowForm">
                            <div class="form-group">
                                <label for="channelName">Discord Channel:</label>
                                <select id="channelName" required>
                                    <option value="">Select a channel...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="buttonTemplate">Template:</label>
                                <select id="buttonTemplate" onchange="loadTemplate()">
                                    <option value="">Select a template...</option>
                                    <option value="custom">Custom</option>
                                    <option value="exclusive">Exclusive Content</option>
                                    <option value="premium">Premium Access</option>
                                    <option value="download">Download</option>
                                    <option value="claim">Claim Reward</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="buttonTitle">Title:</label>
                                <input type="text" id="buttonTitle" placeholder="üéØ Get Your Exclusive Content!" value="üéØ Get Your Exclusive Content!">
                            </div>

                            <div class="form-group">
                                <label for="buttonDescription">Description:</label>
                                <textarea id="buttonDescription" placeholder="Click the button below to receive personalized content based on your role!">Click the button below to receive personalized content based on your role!</textarea>
                            </div>

                            <div class="form-group">
                                <label for="buttonText">Button Text:</label>
                                <input type="text" id="buttonText" placeholder="Get Now" value="Get Now">
                            </div>

                            <div class="form-group">
                                <label for="buttonEmoji">Button Emoji:</label>
                                <div class="emoji-selection">
                                    <input type="text" id="buttonEmoji" placeholder="üéØ" value="üéØ">
                                    <button type="button" class="emoji-picker-btn" onclick="openEmojiPicker('buttonEmoji')">üòÄ</button>
                                    <div class="emoji-picker-container">
                                        <div class="emoji-tabs">
                                            <button type="button" class="emoji-tab active" onclick="switchEmojiTab('unicode')">Unicode</button>
                                            <button type="button" class="emoji-tab" onclick="switchEmojiTab('server')">Server</button>
                                        </div>
                                        <div class="emoji-picker-content">
                                            <div id="unicodeEmojis" class="emoji-grid">
                                                <!-- Unicode emojis will be loaded here -->
                                            </div>
                                            <div id="serverEmojis" class="emoji-grid" style="display: none;">
                                                <!-- Server emojis will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="buttonColor">Button Color:</label>
                                <select id="buttonColor" class="form-control">
                                    <option value="primary">Primary (Blue)</option>
                                    <option value="secondary">Secondary (Gray)</option>
                                    <option value="success">Success (Green)</option>
                                    <option value="danger">Danger (Red)</option>
                                    <option value="blurple">Blurple (Discord)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="buttonLogo">Logo URL (Optional):</label>
                                <input type="url" id="buttonLogo" placeholder="https://example.com/logo.png">
                                <small style="color: var(--text-secondary);">Add a logo image above the button</small>
                            </div>
                            
                            <div class="form-group">
                                <label>Role-Based DMs:</label>
                                <div id="roleDMsContainer">
                                    <div class="role-dm-entry" style="margin-bottom: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px;">
                                        <div class="form-group">
                                            <label>Role:</label>
                                            <select class="roleSelect" required>
                                                <option value="">Select a role...</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>DM Message:</label>
                                            <textarea class="roleMessage" placeholder="Enter message for this role... (Type # for channel suggestions)" required></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label>Embed Title (optional):</label>
                                            <input type="text" class="embedTitle" placeholder="Embed title...">
                                        </div>
                                        <div class="form-group">
                                            <label>Embed Color (optional):</label>
                                            <input type="color" class="embedColor" value="#00ff00">
                                        </div>
                                        <div class="form-group">
                                            <div class="checkbox-group">
                                                <input type="checkbox" class="includeServerLogo">
                                                <label>Include server logo in DM</label>
                                            </div>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="removeRoleDMEntry(this)" style="width: auto; padding: 8px 16px;">Remove Role</button>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success" onclick="addRoleDMEntry()" style="width: auto; padding: 8px 16px; margin-top: 10px;">+ Add Another Role</button>
                            </div>
                            
                            <div class="form-group">
                                <label for="noRoleMessage">No-Role Message (for users without any of the above roles):</label>
                                <textarea id="noRoleMessage" placeholder="No problem! Click anyway and our team will contact you.">No problem! Click anyway and our team will contact you.</textarea>
                            </div>
                            <div class="template-preview" id="templatePreview" style="display: none;">
                                <h4 id="previewTitle">üéØ Get Your Exclusive Content!</h4>
                                <p id="previewDescription">Click the button below to receive personalized content based on your role!</p>
                                <button class="preview-button" id="previewButton">üéØ Get Now</button>
                            </div>

                            <button type="button" class="btn btn-warning" onclick="testRoleLoading()" style="margin-right: 10px;">Test Role Loading</button>
                            <button type="submit" class="btn">Create Get Now Button</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>üìã Active Get Now Buttons</h3>
                        <div id="getNowList">
                            <p style="color: #718096; text-align: center;">No active Get Now buttons</p>
                        </div>
                        <button class="btn btn-success" onclick="loadGetNowButtons()">üîÑ Refresh</button>
                    </div>
                </div>
            </div>

            <!-- Role DMs Tab -->
            <div id="roledms" class="tab-panel">
                <h2 class="section-title">üí¨ Role DM Management - UPDATED v2.0</h2>
                <div style="background: #00ff00; color: #000; padding: 10px; margin: 10px 0; border: 2px solid #ff0000; font-weight: bold; text-align: center;">
                    üö® TEMPLATE UPDATED - If you see this, the new template is loading! üö®
                </div>
                
                <div class="two-column">
                    <div class="card">
                        <h3>‚ûï Set Role DM</h3>
                        <form id="setdmForm">
                            <div class="form-group">
                                <label for="roleName">Role:</label>
                                <select id="roleName" required>
                                    <option value="">Select a role...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="roleDMTemplate">Template:</label>
                                <select id="roleDMTemplate" onchange="loadRoleDMTemplate()">
                                    <option value="">Select a template...</option>
                                    <option value="welcome">Welcome Message</option>
                                    <option value="congratulations">Congratulations</option>
                                    <option value="reward">Reward Claim</option>
                                    <option value="exclusive">Exclusive Access</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="dmTitle">DM Title (Optional):</label>
                                <input type="text" id="dmTitle" placeholder="Enter a custom title for the DM embed...">
                                <small style="color: var(--text-secondary);">Leave empty to use default title</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="dmMessage">Custom DM Message:</label>
                                <textarea id="dmMessage" placeholder="Enter the message to send when someone gets this role... (Type # for channel suggestions)" required></textarea>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="claimButton" onchange="toggleRoleDMClaimRole()">
                                    <label for="claimButton">Add claim button to DM</label>
                            </div>
                            </div>
                            <div class="form-group" id="roleDMClaimRoleGroup" style="display: none;">
                                <label for="roleDMClaimRole">Role to Claim:</label>
                                <select id="roleDMClaimRole" name="claim_role" class="form-control">
                                    <option value="">Select a role...</option>
                                </select>
                            </div>
                            <div class="form-group" id="roleDMButtonCustomization" style="display: none;">
                                <label for="roleDMButtonText">Button Text:</label>
                                <input type="text" id="roleDMButtonText" name="button_text" class="form-control" placeholder="Claim Rewards" value="Claim Rewards">
                                <small style="color: var(--text-secondary);">Customize the button text</small>
                            </div>
                            <div class="form-group" id="roleDMButtonColor" style="display: none;">
                                <label for="roleDMButtonColorInput">Button Color:</label>
                                <select id="roleDMButtonColorInput" name="button_color" class="form-control">
                                    <option value="success">Green (Success)</option>
                                    <option value="primary">Blue (Primary)</option>
                                    <option value="secondary">Gray (Secondary)</option>
                                    <option value="danger">Red (Danger)</option>
                                </select>
                                <small style="color: var(--text-secondary);">Choose the button color style</small>
                            </div>
                            <div class="form-group" id="roleDMButtonEmoji" style="display: none;">
                                <label for="roleDMButtonEmojiInput">Button Emoji:</label>
                                <div class="emoji-selection">
                                    <input type="text" id="roleDMButtonEmojiInput" name="button_emoji" class="form-control" placeholder="üéÅ" value="üéÅ">
                                    <button type="button" class="emoji-picker-btn" onclick="openEmojiPicker('roleDMButtonEmojiInput')">üòÄ</button>
                                    <div class="emoji-picker-container">
                                        <div class="emoji-tabs">
                                            <button type="button" class="emoji-tab active" onclick="switchEmojiTab('unicode')">Unicode</button>
                                            <button type="button" class="emoji-tab" onclick="switchEmojiTab('server')">Server</button>
                                        </div>
                                        <div class="emoji-picker-content">
                                            <div class="unicode-emojis emoji-grid">
                                                <!-- Unicode emojis will be loaded here -->
                                            </div>
                                            <div class="server-emojis emoji-grid" style="display: none;">
                                                <!-- Server emojis will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <small style="color: var(--text-secondary);">Enter an emoji or use the picker for Discord/custom emojis</small>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="includeServerLogo">
                                    <label for="includeServerLogo">Include server logo in DM</label>
                            </div>
                            </div>
                            <button type="submit" class="btn">Set Role DM</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>üìã Active Role DMs</h3>
                        <div id="roleDMsList">
                            <p style="color: #718096; text-align: center;">No role DMs configured</p>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-success" onclick="loadRoleDMs()">üîÑ Refresh</button>
                            <button class="btn btn-warning" onclick="cleanAllRoleDMs()">üßπ Clean Messages</button>
                        </div>
                    </div>
                </div>
                
                <!-- Separator -->
                <div style="width: 100%; height: 2px; background: linear-gradient(90deg, transparent, var(--primary-color), transparent); margin: 40px 0;"></div>
                
                <!-- Quick DM Section -->
                <div class="quick-dm-section" style="margin-top: 30px; clear: both;">
                    <div class="card" style="border: 2px solid var(--primary-color); background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);">
                        <h3 style="color: var(--primary-color); border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;">‚ö° Quick DM - Mass Send</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Instantly send a custom message to all members with a specific role</p>
                        
                        <form id="quickDMForm">
                            <div class="form-group">
                                <label for="quickDMRole">Target Role:</label>
                                <select id="quickDMRole" required>
                                    <option value="">Select a role to DM...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="quickDMTitle">Message Title (Optional):</label>
                                <input type="text" id="quickDMTitle" placeholder="Enter a title for the message...">
                            </div>
                            
                            <div class="form-group">
                                <label for="quickDMMessage">Message Content:</label>
                                <textarea id="quickDMMessage" placeholder="Enter your message to send to all role members..." required rows="4"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="quickDMIncludeLogo">
                                    <label for="quickDMIncludeLogo">Include server logo in message</label>
                                </div>
                            </div>
                            
                            <div class="quick-dm-actions">
                                <button type="button" class="btn btn-primary" onclick="sendQuickDM()">
                                    <span class="btn-icon">üì§</span>
                                    Send Quick DM
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="previewQuickDM()">
                                    <span class="btn-icon">üëÅÔ∏è</span>
                                    Preview Message
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testDMPermissions()">
                                    <span class="btn-icon">üîç</span>
                                    Test DM Permissions
                                </button>
                            </div>
                        </form>
                        
                        <div id="quickDMStatus" class="quick-dm-status" style="display: none;">
                            <div class="status-content">
                                <div class="status-icon">‚è≥</div>
                                <div class="status-text">
                                    <div class="status-title">Sending Messages...</div>
                                    <div class="status-details">Please wait while we send your message to all role members.</div>
                                </div>
                            </div>
                            <div class="progress-bar">
                                <div class="progress-fill" id="quickDMProgress"></div>
                            </div>
                        </div>
                        
                        <div id="quickDMResults" class="quick-dm-results" style="display: none;">
                            <div class="results-header">
                                <h4>üìä Quick DM Results</h4>
                                <button type="button" class="close-btn" onclick="closeQuickDMResults()">√ó</button>
                            </div>
                            <div class="results-content">
                                <div class="result-item success">
                                    <span class="result-icon">‚úÖ</span>
                                    <span class="result-text">Successfully sent: <strong id="successCount">0</strong></span>
                                </div>
                                <div class="result-item error">
                                    <span class="result-icon">‚ùå</span>
                                    <span class="result-text">Failed to send: <strong id="errorCount">0</strong></span>
                                </div>
                                <div class="result-item warning">
                                    <span class="result-icon">‚è≠Ô∏è</span>
                                    <span class="result-text">Skipped (Opted Out): <strong id="skippedCount">0</strong></span>
                                </div>
                                <div class="result-item info">
                                    <span class="result-icon">üö´</span>
                                    <span class="result-text">DMs Disabled: <strong id="dmDisabledCount">0</strong></span>
                                </div>
                                <div class="result-item info">
                                    <span class="result-icon">‚ÑπÔ∏è</span>
                                    <span class="result-text">Total members: <strong id="totalCount">0</strong></span>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            
            <!-- Marketing Tab -->
            <div id="marketing" class="tab-panel">
                <h2 class="section-title">üì¢ Marketing Campaigns</h2>
                <div class="two-column">
                    <div class="card">
                        <h3>üöÄ Start Marketing Campaign</h3>
                        <form id="marketingForm">
                            <div class="form-group">
                                <label for="roleNames">Target Roles:</label>
                                <select id="roleNames" multiple required style="height: 100px;">
                                    <option value="">Select roles...</option>
                                </select>
                                <small style="color: #718096;">Hold Ctrl/Cmd to select multiple roles</small>
                            </div>
                            <div class="form-group">
                                <label for="marketingMessage">Marketing Message:</label>
                                <textarea id="marketingMessage" placeholder="Enter your marketing message... (Type # for channel suggestions)" required></textarea>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="marketingClaim" onchange="toggleClaimRole()">
                                    <label for="marketingClaim">Add claim button</label>
                                </div>
                            </div>
                            <div class="form-group" id="claimRoleGroup" style="display: none;">
                                <label for="claimRole">Role to Claim:</label>
                                <select id="claimRole" name="claim_role" class="form-control">
                                    <option value="">Select a role...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="includeMarketingServerLogo">
                                    <label for="includeMarketingServerLogo">Include server logo in marketing message</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="interval">Interval (optional):</label>
                                <input type="text" id="interval" placeholder="1d2h30m (days, hours, minutes)">
                            </div>
                            <button type="submit" class="btn">Start Campaign</button>
                        </form>
                    </div>
                    
                    <div class="card">
                        <h3>üìà Active Campaigns</h3>
                        <div id="campaignsList">
                            <p style="color: #718096; text-align: center;">No active campaigns</p>
                        </div>
                        <button class="btn btn-success" onclick="loadCampaigns()">üîÑ Refresh</button>
                    </div>
                </div>
                
                <!-- Opt-Out Management -->
                <div class="card" style="margin-top: 20px; background: rgba(239, 68, 68, 0.1); border: 1px solid #ef4444;">
                    <h3>üö´ Opt-Out Management</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Users can reply "stop" to any marketing DM to unsubscribe. View and manage opt-outs here.
                    </p>
                    
                    <div class="opt-out-stats" style="display: flex; gap: 20px; margin-bottom: 15px;">
                        <div class="stat-item">
                            <div class="stat-value" id="totalOptOuts">0</div>
                            <div class="stat-label">Total Opt-Outs</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="recentOptOuts">0</div>
                            <div class="stat-label">This Week</div>
                        </div>
                    </div>
                    
                    <div class="opt-out-actions" style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-primary" onclick="loadOptOuts()">üîÑ Refresh</button>
                        <button class="btn btn-warning" onclick="exportOptOuts()">üìä Export</button>
                    </div>
                    
                    <div id="optOutsList" class="opt-outs-list" style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px;">
                        <p style="color: var(--text-secondary); text-align: center;">Loading opt-outs...</p>
                    </div>
                </div>
            </div>
            
            <!-- Leads Tab -->
            <div id="leads" class="tab-panel">
                <h2 class="section-title">üî• Lead Management</h2>
                <div class="grid">
                    <div class="card">
                        <h3>üìã Pending Leads</h3>
                        <div id="leadsList">
                            <p style="color: #718096; text-align: center;">No pending leads</p>
                        </div>
                        <button class="btn btn-success" onclick="loadLeads()">üîÑ Refresh Leads</button>
                    </div>
                    
                    <div class="card">
                        <h3>üìä Lead Statistics</h3>
                        <div id="leadStats">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="label">Pending</div>
                                    <div class="value" id="pendingLeads">0</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">Converted</div>
                                    <div class="value" id="convertedLeads">0</div>
                                </div>
                                <div class="info-item">
                                    <div class="label">Total</div>
                                    <div class="value" id="totalLeads">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- AI Analytics Tab -->
            <div id="analytics" class="tab-panel">
                <h2 class="section-title">ü§ñ AI Analytics & Tracking</h2>
                
                <!-- AI Tracking Control -->
                <div class="card" style="margin-bottom: 20px; background: rgba(139, 92, 246, 0.1); border: 1px solid #8b5cf6;">
                    <h3>üéõÔ∏è AI Tracking Control</h3>
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                        <span id="aiStatusText" style="font-weight: bold; font-size: 16px;">AI Tracking: DISABLED</span>
                        <button id="aiToggleBtn" class="btn btn-success" onclick="toggleAITracking()">
                            Enable AI Tracking
                        </button>
                    </div>
                    <p style="color: var(--text-secondary); margin: 0;">
                        <strong>Note:</strong> AI tracking only monitors custom links in role DMs, Get Now buttons, and marketing campaigns. 
                        Dashboard interactions are NOT tracked.
                    </p>
                </div>
                
                <div class="analytics-overview">
                    <div class="grid">
                <div class="card">
                    <h3>üìä Overview</h3>
                    <div class="analytics-stats">
                        <div class="stat-item">
                            <div class="stat-value" id="totalInteractions">0</div>
                            <div class="stat-label">Total Interactions</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="uniqueUsers">0</div>
                            <div class="stat-label">Unique Users</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="topInteraction">-</div>
                            <div class="stat-label">Most Popular</div>
                        </div>
                    </div>
                            <button class="btn btn-primary" onclick="refreshAnalytics()">
                        <span class="btn-icon">üîÑ</span>
                        Refresh Data
                    </button>
                </div>
                
                    <div class="card">
                        <h3>üîó Top Links</h3>
                        <div id="topLinksList" class="analytics-list">
                                <p style="color: var(--text-secondary); text-align: center;">Loading...</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üîò Top Buttons</h3>
                        <div id="topButtonsList" class="analytics-list">
                                <p style="color: var(--text-secondary); text-align: center;">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="analytics-details">
                    <div class="two-column">
                <div class="card">
                    <h3>üß† AI Insights</h3>
                    <div id="aiInsights" class="insights-container">
                                <p style="color: var(--text-secondary); text-align: center;">Click "Generate Insights" to see AI analysis</p>
                    </div>
                    <button class="btn btn-secondary" onclick="generateInsights()">
                        <span class="btn-icon">ü§ñ</span>
                        Generate AI Insights
                    </button>
                        </div>
                        
                        <div class="card">
                            <h3>üìà Recent Activity</h3>
                            <div id="recentActivity" class="activity-list">
                                <p style="color: var(--text-secondary); text-align: center;">Loading...</p>
                            </div>
                        </div>
                </div>
            </div>

                <div class="analytics-export">
                <div class="card">
                        <h3>üì§ Export Data</h3>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Export all tracking data for external analysis</p>
                        <div class="export-actions">
                            <button class="btn btn-primary" onclick="exportAnalytics()">
                                <span class="btn-icon">üìä</span>
                                Export CSV
                            </button>
                            <button class="btn btn-secondary" onclick="clearAnalytics()">
                                <span class="btn-icon">üóëÔ∏è</span>
                                Clear Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-panel">
                <h2 class="section-title">‚öôÔ∏è Bot Settings</h2>
                <div class="grid">
                <div class="card">
                        <h3>üîß Bot Management</h3>
                        <button class="btn btn-success" onclick="syncCommands()">üîÑ Sync Commands</button>
                        <button class="btn btn-warning" onclick="restartBot()">üîÑ Restart Bot</button>
                    </div>
                    
                <div class="card">
                    <h3>üè∑Ô∏è Server Logo</h3>
                    <form id="logoForm">
                        <div class="form-group">
                            <label for="serverLogoUrl">Server Logo URL:</label>
                            <input type="url" id="serverLogoUrl" placeholder="https://example.com/logo.png">
                            <small style="color: var(--text-secondary);">Upload your server logo to use in all DMs and marketing messages</small>
                        </div>
                        <div class="form-group">
                            <label for="logoFile">Or Upload File:</label>
                            <input type="file" id="logoFile" accept="image/*" onchange="handleLogoUpload()">
                            <small style="color: var(--text-secondary);">Supported formats: PNG, JPG, GIF (Max 8MB)</small>
                        </div>
                        <button type="submit" class="btn">Save Logo</button>
                    </form>
                    <div id="currentLogo" style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p style="color: var(--text-secondary); text-align: center;">Loading current logo...</p>
                </div>
            </div>

                <div class="card">
                    <h3>üìù Logging Channels</h3>
                        <form id="loggingForm">
                            <div class="form-group">
                                <label for="logType">Log Type:</label>
                                <select id="logType" required>
                                    <option value="general">General Bot Logs</option>
                                    <option value="role_tracker">Role Tracker</option>
                                    <option value="dm_tracker">DM Tracker</option>
                                    <option value="message_tracker">Message Tracker</option>
                                    <option value="leads">Lead Generation</option>
                                    <option value="marketing">Marketing Campaigns</option>
                                    <option value="getnow">Get Now Buttons</option>
                                    <option value="errors">Error Logs</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="loggingChannel">Select Channel:</label>
                                <select id="loggingChannel" required>
                                    <option value="">Select a channel...</option>
                                </select>
                                <small style="color: #718096;">Choose where this type of log will be sent</small>
                            </div>
                            <button type="submit" class="btn">Set Logging Channel</button>
                        </form>
                        <div id="currentLoggingChannels" style="margin-top: 15px; padding: 10px; background: #f7fafc; border-radius: 8px;">
                            <p style="color: #718096; text-align: center;">Loading current logging channels...</p>
                </div>
            </div>

                <div class="card">
                        <h3>üìä Server Information</h3>
                        <div id="serverInfo">
                            <p style="color: #718096; text-align: center;">Loading server information...</p>
                </div>
            </div>

                <!-- Dev Debug Section -->
                <div class="card" style="background: rgba(255, 193, 7, 0.1); border: 1px solid #ffc107;">
                    <h3>üîß Dev Debug Tools</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 15px;">
                        Advanced debugging tools for developers. Use with caution.
                    </p>
                    
                    <div class="debug-controls" style="display: grid; gap: 15px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableDebugLogging" onchange="toggleDebugLogging()">
                                Enable Debug Logging
                            </label>
                            <small style="color: var(--text-secondary); display: block;">Show detailed console logs</small>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableVerboseErrors" onchange="toggleVerboseErrors()">
                                Verbose Error Reporting
                            </label>
                            <small style="color: var(--text-secondary); display: block;">Show detailed error information</small>
                        </div>
                        
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enableRateLimitBypass" onchange="toggleRateLimitBypass()">
                                Bypass Rate Limits (Testing Only)
                            </label>
                            <small style="color: var(--text-secondary); display: block;">‚ö†Ô∏è Only use for testing - may cause issues</small>
                        </div>
                    </div>
                    
                    <div class="debug-actions" style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <button class="btn btn-warning" onclick="testBotConnection()">üîç Test Bot Connection</button>
                        <button class="btn btn-info" onclick="checkBotPermissions()">üîê Check Permissions</button>
                        <button class="btn btn-secondary" onclick="clearBotCache()">üóëÔ∏è Clear Cache</button>
                    </div>
                    
                    <div id="debugResults" style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color); display: none;">
                        <h4 style="color: var(--text-primary); margin-bottom: 15px;">Debug Results</h4>
                        <div id="debugResultsContent">
                            <p style="color: var(--text-secondary); text-align: center;">Running debug checks...</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                        <h3>üìù Default Templates</h3>
                        <p>Edit default message templates used by the bot.</p>
                        <div class="form-group">
                            <label for="defaultTemplateSelect">Select Template:</label>
                            <select id="defaultTemplateSelect" onchange="loadDefaultTemplate()">
                                <option value="">Select a template to edit...</option>
                                <option value="role_dm_welcome">Role DM Welcome</option>
                                <option value="marketing_welcome">Marketing Welcome</option>
                                <option value="get_now_default">Get Now Default</option>
                            </select>
                </div>
                        <div id="templateEditor" style="display: none;">
                            <div class="form-group">
                                <label for="templateTitle">Template Title:</label>
                                <input type="text" id="templateTitle" class="form-control">
            </div>
                            <div class="form-group">
                                <label for="templateContent">Template Content:</label>
                                <textarea id="templateContent" class="form-control" rows="4"></textarea>
        </div>
                            <div class="form-group">
                                <label for="templateDescription">Template Description:</label>
                                <textarea id="templateDescription" class="form-control" rows="3"></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="saveDefaultTemplate()">üíæ Save Template</button>
                            <button class="btn btn-secondary" onclick="resetDefaultTemplate()">üîÑ Reset to Default</button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h3>üß™ Test Functions</h3>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="clearRateLimits" checked>
                                Clear Rate Limits
                            </label>
                            <small style="color: var(--text-secondary); display: block; margin-top: 5px;">
                                Remove all rate limits for testing purposes
                            </small>
                        </div>
                        <button class="btn btn-info" onclick="testAllFunctions()">üß™ Test All Functions</button>
                        <div id="testResults" style="margin-top: 20px; padding: 15px; background: var(--bg-secondary); border-radius: 15px; border: 1px solid var(--border-color); display: none;">
                            <h4 style="color: var(--text-primary); margin-bottom: 15px;">Test Results</h4>
                            <div id="testResultsContent">
                                <p style="color: var(--text-secondary); text-align: center;">Running tests...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alert Container -->
        <div id="alertContainer"></div>
    </div>

    <script>
        // Theme switching
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.querySelector('.theme-icon');
            const themeText = document.getElementById('themeText');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Load saved theme on page load
        function loadTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-icon').textContent = '‚òÄÔ∏è';
                document.getElementById('themeText').textContent = 'Light Mode';
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab panels
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab panel
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'roledms') {
                loadQuickDMRoles(); // Load roles for Quick DM dropdown
            } else if (tabName === 'analytics') {
                refreshAnalytics(); // Load analytics data when switching to analytics tab
            }
        }
        
        // Show alert function
        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        // Sync commands
        async function syncCommands() {
            try {
                const response = await fetch('/api/sync', { method: 'POST' });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Commands synced successfully!', 'success');
                    loadStatus();
                } else {
                    showAlert('Sync failed: ' + (data.error || data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Error syncing commands: ' + error.message, 'error');
            }
        }
        
        // Load server data
        async function loadServerData() {
            try {
                const [rolesResponse, channelsResponse, emojisResponse] = await Promise.all([
                    fetch('/api/roles'),
                    fetch('/api/channels'),
                    fetch('/api/server-emojis')
                ]);
                
                const roles = await rolesResponse.json();
                const channels = await channelsResponse.json();
                const emojis = await emojisResponse.json();
                
                // Store server emojis globally
                window.serverEmojis = emojis.success ? emojis.emojis : [];
                
                // Populate role dropdowns
                const roleSelects = ['roleName', 'requiredRoleName', 'roleNames'];
                roleSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        // Clear existing options except first
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                    
                    roles.forEach(role => {
                        const option = document.createElement('option');
                            option.value = role.name;
                        option.textContent = role.name;
                        select.appendChild(option);
                    });
                    }
                });
                
                // Populate channel dropdowns
                const channelSelects = ['channelName', 'loggingChannel'];
                channelSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        while (select.children.length > 1) {
                            select.removeChild(select.lastChild);
                        }
                        
                        channels.forEach(channel => {
                            const option = document.createElement('option');
                            option.value = channel.name;
                            option.textContent = `#${channel.name}`;
                            select.appendChild(option);
                        });
                    }
                });
            } catch (error) {
                console.error('Error loading server data:', error);
            }
        }
        
        // Add role DM entry
        function addRoleDMEntry() {
            const container = document.getElementById('roleDMsContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'role-dm-entry';
            newEntry.style.cssText = 'margin-bottom: 15px; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px;';
            
            newEntry.innerHTML = `
                <div class="form-group">
                    <label>Role:</label>
                    <select class="roleSelect" required>
                        <option value="">Select a role...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>DM Message:</label>
                    <textarea class="roleMessage" placeholder="Enter message for this role..." required></textarea>
                </div>
                <div class="form-group">
                    <label>Embed Title (optional):</label>
                    <input type="text" class="embedTitle" placeholder="Embed title...">
                </div>
                <div class="form-group">
                    <label>Embed Color (optional):</label>
                    <input type="color" class="embedColor" value="#00ff00">
                </div>
                <button type="button" class="btn btn-danger" onclick="removeRoleDMEntry(this)" style="width: auto; padding: 8px 16px;">Remove Role</button>
            `;
            
            container.appendChild(newEntry);
            
            // Populate role dropdown with a small delay to ensure DOM is ready
            setTimeout(async () => {
                populateRoleDropdown(newEntry.querySelector('.roleSelect'));
                // Ensure channels are loaded before setting up autocomplete
                if (channels.length === 0) {
                    await loadChannels();
                }
                // Setup autocomplete for the new textarea
                const newTextarea = newEntry.querySelector('.roleMessage');
                if (newTextarea) {
                    setupChannelAutocomplete(newTextarea);
                }
            }, 100);
        }
        
        // Populate role dropdown
        async function populateRoleDropdown(selectElement) {
            try {
                console.log('Populating role dropdown...');
                const response = await fetch('/api/roles');
                const roles = await response.json();
                console.log('Roles received:', roles);
                
                selectElement.innerHTML = '<option value="">Select a role...</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.textContent = role.name;
                    selectElement.appendChild(option);
                });
                console.log('Role dropdown populated with', roles.length, 'roles');
            } catch (error) {
                console.error('Error loading roles:', error);
            }
        }
        
        // Remove role DM entry
        function removeRoleDMEntry(button) {
            button.parentElement.remove();
        }
        
        // Test role loading function
        async function testRoleLoading() {
            console.log('Testing role loading...');
            try {
                const response = await fetch('/api/roles');
                const roles = await response.json();
                console.log('API Response:', roles);
                
                // Find all role dropdowns and populate them
                const roleSelects = document.querySelectorAll('.roleSelect');
                console.log('Found', roleSelects.length, 'role dropdowns');
                
                roleSelects.forEach((select, index) => {
                    console.log('Populating dropdown', index);
                    select.innerHTML = '<option value="">Select a role...</option>';
                    
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.name;
                        option.textContent = role.name;
                        select.appendChild(option);
                    });
                });
                
                alert(`Successfully loaded ${roles.length} roles into ${roleSelects.length} dropdowns!`);
            } catch (error) {
                console.error('Error testing role loading:', error);
                alert('Error loading roles: ' + error.message);
            }
        }
        
        // Template system
        const templates = {
            exclusive: {
                title: "üéØ Get Your Exclusive Content!",
                description: "Click the button below to receive personalized content based on your role!",
                buttonText: "Get Now",
                buttonEmoji: "üéØ"
            },
            premium: {
                title: "üíé Unlock Premium Access!",
                description: "Get exclusive premium content tailored to your membership level!",
                buttonText: "Unlock Premium",
                buttonEmoji: "üíé"
            },
            download: {
                title: "üì• Download Your Content!",
                description: "Click below to download your personalized content package!",
                buttonText: "Download",
                buttonEmoji: "üì•"
            },
            claim: {
                title: "üéÅ Claim Your Reward!",
                description: "Don't miss out on your exclusive reward - claim it now!",
                buttonText: "Claim Reward",
                buttonEmoji: "üéÅ"
            },
            custom: {
                title: "Custom Button",
                description: "Create your own custom button with emoji and text!",
                buttonText: "Click Me",
                buttonEmoji: "üöÄ"
            }
        };

        const roleDMTemplates = {
            welcome: {
                message: "üéâ Welcome to {server_name}, {user_name}! You've been granted the **{role_name}** role! Enjoy your new privileges and welcome to our community!"
            },
            congratulations: {
                message: "üéä Congratulations {user_name}! You've earned the **{role_name}** role in {server_name}! This is a special achievement - well done!"
            },
            reward: {
                message: "üéÅ Great news {user_name}! You've received the **{role_name}** role in {server_name}! Click the button below to claim your exclusive rewards!"
            },
            exclusive: {
                message: "‚ú® Welcome {user_name}! You now have **{role_name}** access in {server_name}! This gives you exclusive benefits and special privileges. Enjoy!"
            },
            custom: {
                message: "Hello {user_name}! You've been given the **{role_name}** role in {server_name}. Customize this message to fit your needs!"
            }
        };

        function loadTemplate() {
            const templateSelect = document.getElementById('buttonTemplate');
            const template = templates[templateSelect.value];
            
            if (template) {
                document.getElementById('buttonTitle').value = template.title;
                document.getElementById('buttonDescription').value = template.description;
                document.getElementById('buttonText').value = template.buttonText;
                document.getElementById('buttonEmoji').value = template.buttonEmoji;
                updatePreview();
            }
        }

        function loadRoleDMTemplate() {
            const templateSelect = document.getElementById('roleDMTemplate');
            const template = roleDMTemplates[templateSelect.value];
            
            if (template) {
                document.getElementById('dmMessage').value = template.message;
            }
        }

        function updatePreview() {
            const title = document.getElementById('buttonTitle').value;
            const description = document.getElementById('buttonDescription').value;
            const buttonText = document.getElementById('buttonText').value;
            const buttonEmoji = document.getElementById('buttonEmoji').value;
            const buttonColor = document.getElementById('buttonColor').value;
            
            document.getElementById('previewTitle').textContent = title;
            document.getElementById('previewDescription').textContent = description;
            
            // Handle emoji display in preview
            const previewButton = document.getElementById('previewButton');
            if (buttonEmoji && buttonText) {
                // Both emoji and text
                if (buttonEmoji.startsWith('<') && buttonEmoji.endsWith('>')) {
                    // Custom emoji - show as text for preview
                    previewButton.textContent = '[Custom Emoji] ' + buttonText;
                } else {
                    // Regular emoji
                    previewButton.textContent = buttonEmoji + ' ' + buttonText;
                }
            } else if (buttonEmoji) {
                // Only emoji
                if (buttonEmoji.startsWith('<') && buttonEmoji.endsWith('>')) {
                    previewButton.textContent = '[Custom Emoji]';
                } else {
                    previewButton.textContent = buttonEmoji;
                }
            } else {
                // Only text
                previewButton.textContent = buttonText;
            }
            
            // Update button color in preview
            const colorClasses = {
                'primary': 'preview-button-primary',
                'secondary': 'preview-button-secondary', 
                'success': 'preview-button-success',
                'danger': 'preview-button-danger',
                'blurple': 'preview-button-blurple'
            };
            
            // Remove all color classes
            Object.values(colorClasses).forEach(cls => previewButton.classList.remove(cls));
            
            // Add the selected color class
            if (colorClasses[buttonColor]) {
                previewButton.classList.add(colorClasses[buttonColor]);
            }
            
            // Show preview if any field has content
            const preview = document.getElementById('templatePreview');
            if (title || description || buttonText) {
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
        }

        // Add event listeners for preview updates
        document.addEventListener('DOMContentLoaded', function() {
            ['buttonTitle', 'buttonDescription', 'buttonText', 'buttonEmoji', 'buttonColor'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
        });

        // Emoji picker functions
        let currentEmojiTarget = null;

        function openEmojiPicker(targetId) {
            currentEmojiTarget = targetId;
            
            // Find the emoji picker container for this specific input
            const input = document.getElementById(targetId);
            const emojiSelection = input.closest('.emoji-selection');
            const container = emojiSelection.querySelector('.emoji-picker-container');
            
            if (container) {
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
                
                if (container.style.display === 'block') {
                    loadUnicodeEmojis(container);
                    loadServerEmojis(container);
                }
            }
        }

        function switchEmojiTab(tab) {
            // Update tab buttons in the current emoji picker
            const emojiPicker = event.target.closest('.emoji-picker-container');
            if (emojiPicker) {
                emojiPicker.querySelectorAll('.emoji-tab').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                // Show/hide content
                const unicodeContainer = emojiPicker.querySelector('.unicode-emojis');
                const serverContainer = emojiPicker.querySelector('.server-emojis');
                
                if (unicodeContainer) {
                    unicodeContainer.style.display = tab === 'unicode' ? 'flex' : 'none';
                }
                if (serverContainer) {
                    serverContainer.style.display = tab === 'server' ? 'flex' : 'none';
                }
            }
        }

        function selectEmoji(targetId, emoji) {
            // Set emoji in the target field
            document.getElementById(targetId).value = emoji;
            if (typeof updatePreview === 'function') {
                updatePreview();
            }
            
            // Find and close the specific emoji picker container
            const input = document.getElementById(targetId);
            const emojiSelection = input.closest('.emoji-selection');
            const container = emojiSelection.querySelector('.emoji-picker-container');
            if (container) {
                container.style.display = 'none';
            }
        }

        function loadUnicodeEmojis(container) {
            const unicodeEmojis = [
                'üéØ', 'üíé', 'üì•', 'üéÅ', 'üöÄ', '‚≠ê', 'üî•', 'üíØ', 'üéâ', '‚ú®', 
                'üí™', 'üéä', 'üèÜ', 'üí´', 'üåü', 'üé®', 'üé≠', 'üé™', 'üé∏', 'üéµ',
                'üé∂', 'üé§', 'üéß', 'üé¨', 'üéÆ', 'üïπÔ∏è', 'üé≤', 'üß©', 'üéØ', 'üé™',
                'üé®', 'üé≠', 'üé™', 'üé∏', 'üéµ', 'üé∂', 'üé§', 'üéß', 'üé¨', 'üéÆ'
            ];
            
            const unicodeContainer = container.querySelector('.unicode-emojis');
            if (unicodeContainer) {
                unicodeContainer.innerHTML = unicodeEmojis.map(emoji => 
                    `<div class="emoji-item" onclick="selectEmoji('${currentEmojiTarget}', '${emoji}')" title="${emoji}">${emoji}</div>`
                ).join('');
            }
        }

        async function loadServerEmojis(container) {
            try {
                const response = await fetch('/api/emojis');
                const data = await response.json();
                
                if (data.success) {
                    const serverContainer = container.querySelector('.server-emojis');
                    if (serverContainer) {
                        serverContainer.innerHTML = data.emojis.map(emoji => 
                            `<div class="emoji-item" onclick="selectEmoji('${currentEmojiTarget}', '${emoji.display}')" title="${emoji.name}">
                                <img src="${emoji.url}" alt="${emoji.name}" class="server-emoji">
                                <div class="emoji-name">${emoji.name}</div>
                            </div>`
                        ).join('');
                    }
                } else {
                    console.error('Failed to load server emojis:', data.message);
                    const serverContainer = container.querySelector('.server-emojis');
                    if (serverContainer) {
                        serverContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No server emojis available</div>';
                    }
                }
            } catch (error) {
                console.error('Error loading server emojis:', error);
                const serverContainer = container.querySelector('.server-emojis');
                if (serverContainer) {
                    serverContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">Error loading emojis</div>';
                }
            }
        }

            // Close emoji picker when clicking outside
            document.addEventListener('click', function(event) {
                const picker = document.querySelector('.emoji-picker-container');
                const button = document.querySelector('.emoji-picker-btn');
                
                if (picker && !picker.contains(event.target) && !button.contains(event.target)) {
                    picker.style.display = 'none';
                }
            });


        // Get Now Button form
        document.getElementById('getNowForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const channelName = document.getElementById('channelName').value;
            const noRoleMessage = document.getElementById('noRoleMessage').value;
                const buttonText = document.getElementById('buttonText').value || 'Get Now';
                const buttonEmoji = document.getElementById('buttonEmoji').value || 'üéØ';
                const buttonColor = document.getElementById('buttonColor').value || 'primary';
                const buttonTitle = document.getElementById('buttonTitle').value || 'üéØ Get Your Exclusive Content!';
                const buttonDescription = document.getElementById('buttonDescription').value || 'Click the button below to receive personalized content based on your role!';
                const buttonLogo = document.getElementById('buttonLogo').value;
            
            // Collect role DMs
            const roleDMs = [];
            const roleEntries = document.querySelectorAll('.role-dm-entry');
            
            for (const entry of roleEntries) {
                const roleSelect = entry.querySelector('.roleSelect');
                const roleMessage = entry.querySelector('.roleMessage');
                const embedTitle = entry.querySelector('.embedTitle');
                const embedColor = entry.querySelector('.embedColor');
                const includeServerLogo = entry.querySelector('.includeServerLogo').checked;
                
                if (roleSelect.value && roleMessage.value) {
                    const embedData = {};
                    if (embedTitle.value) embedData.title = embedTitle.value;
                    if (embedColor.value) embedData.color = embedColor.value;
                    if (includeServerLogo) embedData.include_server_logo = true;
                    
                    roleDMs.push({
                        role_name: roleSelect.value,
                        message: roleMessage.value,
                        embed_data: Object.keys(embedData).length > 0 ? embedData : null
                    });
                }
            }
            
            if (roleDMs.length === 0) {
                showAlert('Please add at least one role DM', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/getnow', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            channel_name: channelName, 
                            role_dms: roleDMs,
                            no_role_message: noRoleMessage,
                            button_text: buttonText,
                            button_emoji: buttonEmoji,
                            button_color: buttonColor,
                            button_title: buttonTitle,
                            button_description: buttonDescription,
                            button_logo: buttonLogo
                        })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Get Now button created successfully!', 'success');
                    document.getElementById('getNowForm').reset();
                    // Reset role DMs container
                    document.getElementById('roleDMsContainer').innerHTML = '';
                    addRoleDMEntry(); // Add one default entry
                    loadGetNowButtons();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error creating button: ' + error.message, 'error');
            }
        });
        
        // Set DM form
        document.getElementById('setdmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roleName = document.getElementById('roleName').value;
            const title = document.getElementById('dmTitle').value;
            const message = document.getElementById('dmMessage').value;
            const claim = document.getElementById('claimButton').checked;
            const claimRole = document.getElementById('roleDMClaimRole').value;
            const buttonText = document.getElementById('roleDMButtonText').value || 'Claim Rewards';
            const buttonColor = document.getElementById('roleDMButtonColorInput').value || 'success';
            const buttonEmoji = document.getElementById('roleDMButtonEmojiInput').value || 'üéÅ';
            const includeServerLogo = document.getElementById('includeServerLogo').checked;
            
            if (claim && !claimRole) {
                showAlert('Please select a role to claim when claim button is enabled', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/setdm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        role_name: roleName, 
                        title: title,  // Add title support
                        message, 
                        claim, 
                        claim_role: claimRole, 
                        button_text: buttonText,
                        button_color: buttonColor,
                        button_emoji: buttonEmoji,
                        include_server_logo: includeServerLogo 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Role DM set successfully!', 'success');
                    document.getElementById('setdmForm').reset();
                    loadRoleDMs();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error setting DM: ' + error.message, 'error');
            }
        });
        
        // Toggle claim role dropdown
        function toggleClaimRole() {
            const claimCheckbox = document.getElementById('marketingClaim');
            const claimRoleGroup = document.getElementById('claimRoleGroup');
            const claimRoleSelect = document.getElementById('claimRole');
            
            if (claimCheckbox.checked) {
                claimRoleGroup.style.display = 'block';
                // Populate roles if not already done
                if (claimRoleSelect.children.length === 1) {
                    loadClaimRoles();
                }
            } else {
                claimRoleGroup.style.display = 'none';
                claimRoleSelect.value = '';
            }
        }
        
        // Toggle claim role dropdown for Role DM Management
        function toggleRoleDMClaimRole() {
            const claimCheckbox = document.getElementById('claimButton');
            const claimRoleGroup = document.getElementById('roleDMClaimRoleGroup');
            const claimRoleSelect = document.getElementById('roleDMClaimRole');
            const buttonCustomization = document.getElementById('roleDMButtonCustomization');
            const buttonColor = document.getElementById('roleDMButtonColor');
            const buttonEmoji = document.getElementById('roleDMButtonEmoji');
            
            if (claimCheckbox.checked) {
                claimRoleGroup.style.display = 'block';
                buttonCustomization.style.display = 'block';
                buttonColor.style.display = 'block';
                buttonEmoji.style.display = 'block';
                // Populate roles if not already done
                if (claimRoleSelect.children.length === 1) {
                    loadRoleDMClaimRoles();
                }
            } else {
                claimRoleGroup.style.display = 'none';
                buttonCustomization.style.display = 'none';
                buttonColor.style.display = 'none';
                buttonEmoji.style.display = 'none';
                claimRoleSelect.value = '';
            }
        }
        
        // Load roles for claim dropdown
        async function loadClaimRoles() {
            try {
                const response = await fetch('/api/roles');
                const roles = await response.json();

                const claimRoleSelect = document.getElementById('claimRole');
                claimRoleSelect.innerHTML = '<option value="">Select a role...</option>';

                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.textContent = role.name;
                    claimRoleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for claim:', error);
            }
        }

        
        // Load roles for Role DM claim dropdown
        async function loadRoleDMClaimRoles() {
            try {
                const response = await fetch('/api/roles');
                const roles = await response.json();
                
                const claimRoleSelect = document.getElementById('roleDMClaimRole');
                claimRoleSelect.innerHTML = '<option value="">Select a role...</option>';
                
                roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role.name;
                    option.textContent = role.name;
                    claimRoleSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading roles for Role DM claim:', error);
            }
        }
        
        // Marketing form
        document.getElementById('marketingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roleSelect = document.getElementById('roleNames');
            const roleNames = Array.from(roleSelect.selectedOptions).map(option => option.value);
            const message = document.getElementById('marketingMessage').value;
            const claim = document.getElementById('marketingClaim').checked;
            const claimRole = document.getElementById('claimRole').value;
            const interval = document.getElementById('interval').value;
            const includeServerLogo = document.getElementById('includeMarketingServerLogo').checked;
            
            if (roleNames.length === 0) {
                showAlert('Please select at least one role', 'error');
                return;
            }
            
            if (claim && !claimRole) {
                showAlert('Please select a role to claim when claim button is enabled', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/marketing', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_names: roleNames, message, claim, claim_role: claimRole, interval, include_server_logo: includeServerLogo })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Marketing campaign started!', 'success');
                    document.getElementById('marketingForm').reset();
                    loadCampaigns();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error starting campaign: ' + error.message, 'error');
            }
        });
        
        // Load Get Now buttons
        async function loadGetNowButtons() {
            try {
                const response = await fetch('/api/getnow');
                const buttons = await response.json();
                
                const getNowList = document.getElementById('getNowList');
                
                if (buttons.length === 0) {
                    getNowList.innerHTML = '<p style="color: #718096; text-align: center;">No active Get Now buttons</p>';
                    return;
                }
                
                getNowList.innerHTML = buttons.map(button => `
                    <div class="role-dm-item">
                        <h4>Channel: #${button.channel_name || button.channel_id}</h4>
                        <p><strong>Required Role:</strong> ${button.required_role_name || button.required_role_id}</p>
                        <p><strong>Message:</strong> ${button.message.substring(0, 100)}${button.message.length > 100 ? '...' : ''}</p>
                        <div class="actions">
                            <button class="btn btn-warning" onclick="editGetNowButton('${button.id}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-danger" onclick="removeGetNowButton('${button.id}')">üóëÔ∏è Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Error loading Get Now buttons: ' + error.message, 'error');
            }
        }
        
        // Load role DMs
        async function loadRoleDMs() {
            try {
                const response = await fetch('/api/roledms');
                const roleDMs = await response.json();
                
                const roleDMsList = document.getElementById('roleDMsList');
                
                if (roleDMs.length === 0) {
                    roleDMsList.innerHTML = '<p style="color: #718096; text-align: center;">No role DMs configured</p>';
                    return;
                }
                
                roleDMsList.innerHTML = roleDMs.map(roleDM => `
                    <div class="role-dm-item">
                        <h4>Role: ${roleDM.role_name || roleDM.role_id}</h4>
                        ${roleDM.title ? `<p><strong>Title:</strong> ${roleDM.title}</p>` : ''}
                        <p><strong>Message:</strong> ${roleDM.message.substring(0, 100)}${roleDM.message.length > 100 ? '...' : ''}</p>
                        <p><strong>Claim Button:</strong> ${roleDM.claim ? 'Yes' : 'No'}</p>
                        ${roleDM.claim && roleDM.claim_role ? `<p><strong>Claim Role:</strong> ${roleDM.claim_role}</p>` : ''}
                        ${roleDM.claim && roleDM.button_text ? `<p><strong>Button Text:</strong> ${roleDM.button_text}</p>` : ''}
                        ${roleDM.claim && roleDM.button_color ? `<p><strong>Button Color:</strong> ${roleDM.button_color}</p>` : ''}
                        ${roleDM.claim && roleDM.button_emoji ? `<p><strong>Button Emoji:</strong> ${roleDM.button_emoji}</p>` : ''}
                        <p><strong>Server Logo:</strong> ${roleDM.include_server_logo ? 'Yes' : 'No'}</p>
                        <div class="actions">
                            <button class="btn btn-danger" onclick="removeRoleDM('${roleDM.id}')">Remove</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showAlert('Error loading role DMs: ' + error.message, 'error');
            }
        }
        
        async function cleanAllRoleDMs() {
            if (!confirm('Are you sure you want to clean all role DM messages? This will remove invalid channel references and fix formatting issues.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clean-roledms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadRoleDMs(); // Refresh the list
                } else {
                    showAlert('Failed to clean role DMs: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error cleaning role DMs:', error);
                showAlert('Error cleaning role DMs', 'error');
            }
        }
        
        // Load campaigns
        async function loadCampaigns() {
            try {
                const response = await fetch('/api/campaigns');
                const campaigns = await response.json();
                
                const campaignsList = document.getElementById('campaignsList');
                
                if (campaigns.length === 0) {
                    campaignsList.innerHTML = '<p style="color: #718096; text-align: center;">No active campaigns</p>';
                    return;
                }
                
                campaignsList.innerHTML = campaigns.map(campaign => `
                    <div class="campaign-item">
                        <h4>Campaign ${campaign.key.substring(0, 8)}...</h4>
                        <p><strong>Roles:</strong> ${campaign.role_names ? campaign.role_names.join(', ') : campaign.roles.length}</p>
                        <p><strong>Message:</strong> ${campaign.message}</p>
                        <p><strong>Claim Button:</strong> ${campaign.claim ? 'Yes' : 'No'}</p>
                        ${campaign.claim && campaign.claim_role ? `<p><strong>Claim Role:</strong> ${campaign.claim_role}</p>` : ''}
                        <p><strong>Interval:</strong> ${campaign.interval ? campaign.interval + 's' : 'Once'}</p>
                        <button class="btn btn-danger" onclick="stopCampaign('${campaign.key}')" style="width: auto; margin-top: 10px;">Stop Campaign</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading campaigns:', error);
                const campaignsList = document.getElementById('campaignsList');
                if (campaignsList) {
                    campaignsList.innerHTML = '<p style="color: #f56565; text-align: center;">Error loading campaigns</p>';
                }
            }
        }
        
        // Stop campaign
        async function stopCampaign(key) {
            try {
                const response = await fetch('/api/stop_campaign', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Campaign stopped!', 'success');
                    loadCampaigns();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error stopping campaign: ' + error.message, 'error');
            }
        }
        
        // Load status
        async function loadStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();
                
                document.getElementById('serverCount').textContent = status.guilds.length;
                document.getElementById('commandCount').textContent = status.commands.length;
                document.getElementById('botStatus').textContent = status.running ? 'Online' : 'Offline';
                document.getElementById('botStatus').className = `status ${status.running ? 'online' : 'offline'}`;
                
                // Update server information
                const serverInfo = document.getElementById('serverInfo');
                if (status.guilds && status.guilds.length > 0) {
                    const guild = status.guilds[0];
                    serverInfo.innerHTML = `
                        <p><strong>Server:</strong> ${guild.name}</p>
                        <p><strong>Server ID:</strong> ${guild.id}</p>
                        <p><strong>Members:</strong> <span id="memberCount">${guild.member_count || 'Loading...'}</span> people</p>
                        <p><strong>Bot Permissions:</strong> Send Messages, Manage Roles</p>
                    `;
                } else {
                    serverInfo.innerHTML = '<p style="color: #718096; text-align: center;">Not connected to any servers</p>';
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }
        
        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadStatus();
            loadCampaigns();
            loadRoleDMs();
            loadGetNowButtons();
            loadLeads();
        }, 30000);
        
        // Edit Get Now button
        async function editGetNowButton(buttonId) {
            try {
                // Get current button data
                const response = await fetch('/api/getnow');
                const buttons = await response.json();
                const button = buttons.find(b => b.id === buttonId);
                
                if (!button) {
                    showAlert('Button not found!', 'error');
                    return;
                }
                
                // Show edit modal
                const newMessage = prompt('Enter new message for the Get Now button:', button.message);
                if (newMessage === null) return; // User cancelled
                
                if (newMessage.trim() === '') {
                    showAlert('Message cannot be empty!', 'error');
                    return;
                }
                
                // Update the button
                const updateResponse = await fetch(`/api/getnow/${buttonId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: newMessage.trim() })
                });
                
                const data = await updateResponse.json();
                
                if (data.success) {
                    showAlert('Get Now button message updated!', 'success');
                    loadGetNowButtons();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error editing button: ' + error.message, 'error');
            }
        }
        
        // Remove Get Now button
        async function removeGetNowButton(buttonId) {
            try {
                const response = await fetch(`/api/getnow/${buttonId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Get Now button removed!', 'success');
                    loadGetNowButtons();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error removing button: ' + error.message, 'error');
            }
        }
        
        // Remove role DM
        async function removeRoleDM(roleId) {
            try {
                const response = await fetch(`/api/roledms/${roleId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Role DM removed!', 'success');
                    loadRoleDMs();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error removing role DM: ' + error.message, 'error');
            }
        }
        
        // Load leads
        async function loadLeads() {
            try {
                const response = await fetch('/api/leads');
                const leads = await response.json();
                
                const leadsList = document.getElementById('leadsList');
                
                if (leads.length === 0) {
                    leadsList.innerHTML = '<p style="color: #718096; text-align: center;">No pending leads</p>';
                    return;
                }
                
                leadsList.innerHTML = leads.map(lead => `
                    <div class="role-dm-item">
                        <h4>${lead.user_name}</h4>
                        <p><strong>Channel:</strong> #${lead.channel_name}</p>
                        <p><strong>Button:</strong> ${lead.button_text}</p>
                        <p><strong>Clicked:</strong> ${new Date(lead.clicked_at).toLocaleString()}</p>
                        <div class="actions">
                            <button class="btn btn-success" onclick="updateLeadStatus(${lead.id}, 'contacted')" style="width: auto; padding: 8px 16px;">Mark Contacted</button>
                            <button class="btn btn-warning" onclick="updateLeadStatus(${lead.id}, 'converted')" style="width: auto; padding: 8px 16px;">Mark Converted</button>
                            <button class="btn btn-danger" onclick="updateLeadStatus(${lead.id}, 'rejected')" style="width: auto; padding: 8px 16px;">Reject</button>
                        </div>
                    </div>
                `).join('');
                
                // Update stats
                document.getElementById('pendingLeads').textContent = leads.length;
            } catch (error) {
                showAlert('Error loading leads: ' + error.message, 'error');
            }
        }
        
        // Update lead status
        async function updateLeadStatus(leadId, status) {
            try {
                const response = await fetch(`/api/leads/${leadId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`Lead status updated to ${status}`, 'success');
                    loadLeads();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error updating lead: ' + error.message, 'error');
            }
        }
        
        // Logging channel form
        document.getElementById('loggingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const channelName = document.getElementById('loggingChannel').value;
            const logType = document.getElementById('logType').value;
            
            try {
                const response = await fetch('/api/logging_channels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel_name: channelName, log_type: logType })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadLoggingChannels();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error setting logging channel: ' + error.message, 'error');
            }
        });
        
        // Load current logging channels
        async function loadLoggingChannels() {
            try {
                const response = await fetch('/api/logging_channels');
                const data = await response.json();
                
                const currentChannelsDiv = document.getElementById('currentLoggingChannels');
                
                if (data.success && data.channels) {
                    const channels = data.channels;
                    let html = '<h4 style="margin-bottom: 15px; color: #4a5568;">Configured Logging Channels:</h4>';
                    
                    const logTypeNames = {
                        'general': 'General Bot Logs',
                        'role_tracker': 'Role Tracker',
                        'dm_tracker': 'DM Tracker',
                        'message_tracker': 'Message Tracker',
                        'leads': 'Lead Generation',
                        'marketing': 'Marketing Campaigns',
                        'getnow': 'Get Now Buttons',
                        'errors': 'Error Logs'
                    };
                    
                    for (const [logType, channelInfo] of Object.entries(channels)) {
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #e2e8f0;">
                                <div>
                                    <strong>${logTypeNames[logType] || logType}:</strong> #${channelInfo.name}
                                </div>
                                <button class="btn btn-danger" onclick="removeLoggingChannel('${logType}')" style="width: auto; padding: 4px 8px; font-size: 12px;">Remove</button>
                            </div>
                        `;
                    }
                    
                    currentChannelsDiv.innerHTML = html;
                } else {
                    currentChannelsDiv.innerHTML = '<p style="color: #718096; text-align: center;">No logging channels configured</p>';
                }
            } catch (error) {
                console.error('Error loading logging channels:', error);
                document.getElementById('currentLoggingChannels').innerHTML = '<p style="color: #f56565; text-align: center;">Error loading logging channels</p>';
            }
        }
        
        // Remove logging channel
        async function removeLoggingChannel(logType) {
            try {
                const response = await fetch(`/api/logging_channels/${logType}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert(data.message, 'success');
                    loadLoggingChannels();
                } else {
                    showAlert('Error: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error removing logging channel: ' + error.message, 'error');
            }
        }
        
        // Restart bot (placeholder)
        function restartBot() {
            showAlert('Bot restart functionality coming soon!', 'warning');
        }

        // Default Template Functions
        async function loadDefaultTemplate() {
            const templateSelect = document.getElementById('defaultTemplateSelect');
            const templateEditor = document.getElementById('templateEditor');
            const templateTitle = document.getElementById('templateTitle');
            const templateContent = document.getElementById('templateContent');
            const templateDescription = document.getElementById('templateDescription');
            
            if (!templateSelect.value) {
                templateEditor.style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/default-template/${templateSelect.value}`);
                const data = await response.json();
                
                if (data.success) {
                    templateTitle.value = data.template.title || '';
                    templateContent.value = data.template.content || '';
                    templateDescription.value = data.template.description || '';
                    templateEditor.style.display = 'block';
                } else {
                    showAlert('Failed to load template: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error loading template:', error);
                showAlert('Error loading template', 'error');
            }
        }
        
        async function saveDefaultTemplate() {
            const templateSelect = document.getElementById('defaultTemplateSelect');
            const templateTitle = document.getElementById('templateTitle');
            const templateContent = document.getElementById('templateContent');
            const templateDescription = document.getElementById('templateDescription');
            
            if (!templateSelect.value) {
                showAlert('Please select a template to edit', 'warning');
                return;
            }
            
            try {
                const response = await fetch('/api/default-template', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        template_type: templateSelect.value,
                        title: templateTitle.value,
                        content: templateContent.value,
                        description: templateDescription.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Template saved successfully!', 'success');
                } else {
                    showAlert('Failed to save template: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error saving template:', error);
                showAlert('Error saving template', 'error');
            }
        }
        
        async function resetDefaultTemplate() {
            const templateSelect = document.getElementById('defaultTemplateSelect');
            
            if (!templateSelect.value) {
                showAlert('Please select a template to reset', 'warning');
                return;
            }
            
            if (!confirm('Are you sure you want to reset this template to its default values?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/default-template/${templateSelect.value}/reset`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Template reset to default values!', 'success');
                    loadDefaultTemplate(); // Reload the template
                } else {
                    showAlert('Failed to reset template: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error resetting template:', error);
                showAlert('Error resetting template', 'error');
            }
        }

        // Test Functions
        async function testAllFunctions() {
            const testResults = document.getElementById('testResults');
            const testResultsContent = document.getElementById('testResultsContent');
            const clearRateLimits = document.getElementById('clearRateLimits').checked;
            
            // Show test results container
            testResults.style.display = 'block';
            testResultsContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Running tests...</p>';
            
            try {
                const response = await fetch('/api/test-functions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clear_rate_limits: clearRateLimits })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    let html = '<div style="display: grid; gap: 15px;">';
                    
                    // Bot Status
                    html += `<div style="padding: 10px; background: ${results.bot_status === 'online' ? 'var(--accent-color)' : 'var(--danger-color)'}; border-radius: 8px; color: white;">
                        <strong>ü§ñ Bot Status:</strong> ${results.bot_status.toUpperCase()}
                    </div>`;
                    
                    // Guilds Connected
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>üè† Guilds Connected:</strong> ${results.guilds_connected}
                    </div>`;
                    
                    // Commands Synced
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>‚ö° Commands Synced:</strong> ${results.commands_synced}
                    </div>`;
                    
                    // Role DMs Configured
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>üí¨ Role DMs Configured:</strong> ${results.role_dms_configured}
                    </div>`;
                    
                    // Get Now Buttons
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>üéØ Get Now Buttons:</strong> ${results.getnow_buttons}
                    </div>`;
                    
                    // Active Campaigns
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>üì¢ Active Campaigns:</strong> ${results.campaigns_active}
                    </div>`;
                    
                    // Database Status
                    const dbColor = results.database_connected ? 'var(--accent-color)' : 'var(--danger-color)';
                    html += `<div style="padding: 10px; background: ${dbColor}; border-radius: 8px; color: white;">
                        <strong>üóÑÔ∏è Database:</strong> ${results.database_connected ? 'CONNECTED' : 'DISCONNECTED'}
                        ${results.database_error ? `<br><small>Error: ${results.database_error}</small>` : ''}
                    </div>`;
                    
                    // Rate Limits
                    if (results.rate_limits_cleared) {
                        html += `<div style="padding: 10px; background: var(--warning-color); border-radius: 8px; color: white;">
                            <strong>üßπ Rate Limits:</strong> CLEARED FOR TESTING
                        </div>`;
                    } else {
                        html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                            <strong>‚è±Ô∏è Rate Limits Remaining:</strong> ${results.rate_limits_remaining || 0}
                        </div>`;
                    }
                    
                    // Server Data
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px; border: 1px solid var(--border-color);">
                        <strong>üìä Server Data:</strong><br>
                        <small>Roles: ${results.server_data.roles_count} | Channels: ${results.server_data.channels_count} | Logging Channels: ${results.server_data.logging_channels_count}</small>
                    </div>`;
                    
                    html += '</div>';
                    testResultsContent.innerHTML = html;
                    
                    showAlert('All functions tested successfully!', 'success');
                } else {
                    testResultsContent.innerHTML = `<p style="color: var(--danger-color); text-align: center;">Test failed: ${data.error}</p>`;
                    showAlert('Test failed: ' + data.error, 'error');
                }
            } catch (error) {
                testResultsContent.innerHTML = `<p style="color: var(--danger-color); text-align: center;">Error: ${error.message}</p>`;
                showAlert('Test error: ' + error.message, 'error');
            }
        }

        // Channel Autocomplete Functions
        let channels = [];
        let currentAutocomplete = null;

        async function loadChannels() {
            try {
                console.log('Loading channels...');
                const response = await fetch('/api/channels');
                const data = await response.json();
                console.log('Channels API response:', data);
                
                if (data.success) {
                    channels = data.channels;
                    console.log('Channels loaded successfully:', channels.length, 'channels');
                    console.log('Channel names:', channels.map(c => c.name));
                } else {
                    console.error('Failed to load channels:', data.message);
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        function setupChannelAutocomplete(textarea) {
            console.log('Setting up channel autocomplete for textarea:', textarea.id || textarea.className);
            
            textarea.addEventListener('input', function(e) {
                const cursorPos = e.target.selectionStart;
                const text = e.target.value;
                
                console.log('Input event - text:', text, 'cursorPos:', cursorPos);
                
                // Find the last # before cursor
                const beforeCursor = text.substring(0, cursorPos);
                const lastHashIndex = beforeCursor.lastIndexOf('#');
                
                console.log('Last # index:', lastHashIndex, 'beforeCursor:', beforeCursor);
                
                if (lastHashIndex !== -1) {
                    const afterHash = beforeCursor.substring(lastHashIndex + 1);
                    const hasSpace = afterHash.includes(' ') || afterHash.includes('\n');
                    
                    console.log('After #:', afterHash, 'hasSpace:', hasSpace);
                    
                    if (!hasSpace) {
                        const query = afterHash.toLowerCase();
                        console.log('Calling showChannelSuggestions with query:', query);
                        showChannelSuggestions(textarea, query, lastHashIndex, cursorPos);
                    } else {
                        console.log('Has space, hiding suggestions');
                        hideChannelSuggestions();
                    }
                } else {
                    // Check if the text starts with # (for cases like "#general")
                    if (text.startsWith('#') && !text.includes(' ')) {
                        const query = text.substring(1).toLowerCase();
                        console.log('Text starts with #, calling showChannelSuggestions with query:', query);
                        showChannelSuggestions(textarea, query, 0, cursorPos);
                    } else {
                        console.log('No # found, hiding suggestions');
                        hideChannelSuggestions();
                    }
                }
            });

            textarea.addEventListener('keydown', function(e) {
                if (currentAutocomplete && currentAutocomplete.textarea === textarea) {
                    const suggestions = currentAutocomplete.container.querySelectorAll('.autocomplete-suggestion');
                    const active = currentAutocomplete.container.querySelector('.autocomplete-suggestion.active');
                    
                    if (e.key === 'ArrowDown') {
                        e.preventDefault();
                        if (active) {
                            active.classList.remove('active');
                            const next = active.nextElementSibling;
                            if (next) {
                                next.classList.add('active');
                            } else {
                                suggestions[0].classList.add('active');
                            }
                        } else {
                            suggestions[0].classList.add('active');
                        }
                    } else if (e.key === 'ArrowUp') {
                        e.preventDefault();
                        if (active) {
                            active.classList.remove('active');
                            const prev = active.previousElementSibling;
                            if (prev) {
                                prev.classList.add('active');
                            } else {
                                suggestions[suggestions.length - 1].classList.add('active');
                            }
                        } else {
                            suggestions[suggestions.length - 1].classList.add('active');
                        }
                    } else if (e.key === 'Enter' || e.key === 'Tab') {
                        e.preventDefault();
                        if (active) {
                            selectChannelSuggestion(active, textarea);
                        }
                    } else if (e.key === 'Escape') {
                        hideChannelSuggestions();
                    }
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (currentAutocomplete && !currentAutocomplete.container.contains(e.target) && e.target !== textarea) {
                    hideChannelSuggestions();
                }
            });
        }

        function showChannelSuggestions(textarea, query, hashIndex, cursorPos) {
            console.log('showChannelSuggestions called with query:', query, 'channels available:', channels.length);
            
            const filteredChannels = channels.filter(channel => 
                query === '' || channel.name.toLowerCase().includes(query)
            ).slice(0, 10); // Limit to 10 suggestions

            console.log('Filtered channels:', filteredChannels.length);

            if (filteredChannels.length === 0) {
                console.log('No channels found for query:', query);
                hideChannelSuggestions();
                return;
            }

            // Remove existing autocomplete
            hideChannelSuggestions();

            // Create autocomplete container
            const container = document.createElement('div');
            container.className = 'autocomplete-suggestions';
            container.style.display = 'block';

            // Add suggestions
            filteredChannels.forEach((channel, index) => {
                console.log('Adding channel suggestion:', channel.name, 'ID:', channel.id, 'Type:', channel.type);
                
                const suggestion = document.createElement('div');
                suggestion.className = 'autocomplete-suggestion';
                if (index === 0) suggestion.classList.add('active');
                
                suggestion.innerHTML = `
                    <span class="channel-name">#${channel.name}</span>
                    <span class="channel-id">${channel.id}</span>
                `;
                
                suggestion.addEventListener('click', () => selectChannelSuggestion(suggestion, textarea));
                container.appendChild(suggestion);
            });

            // Position the container
            const rect = textarea.getBoundingClientRect();
            container.style.position = 'absolute';
            container.style.top = '100%';
            container.style.left = '0';
            container.style.right = '0';
            container.style.zIndex = '9999';
            container.style.display = 'block';

            // Add to textarea's parent
            textarea.parentNode.style.position = 'relative';
            textarea.parentNode.appendChild(container);
            
            console.log('Autocomplete container created and positioned');

            currentAutocomplete = {
                container: container,
                textarea: textarea,
                hashIndex: hashIndex,
                cursorPos: cursorPos
            };
        }

        function selectChannelSuggestion(suggestion, textarea) {
            const channelName = suggestion.querySelector('.channel-name').textContent.replace('#', '');
            const channelId = suggestion.querySelector('.channel-id').textContent;
            
            console.log('Selected channel:', channelName, 'ID:', channelId);
            
            // Validate channel ID (should be a valid Discord snowflake)
            if (!channelId || channelId.length < 17 || isNaN(channelId)) {
                console.error('Invalid channel ID:', channelId);
                alert('Invalid channel ID. Please try again.');
                hideChannelSuggestions();
                return;
            }
            
            const text = textarea.value;
            const beforeHash = text.substring(0, currentAutocomplete.hashIndex);
            const afterCursor = text.substring(currentAutocomplete.cursorPos);
            
            const channelLink = `<#${channelId}>`;
            console.log('Creating channel link:', channelLink);
            
            textarea.value = beforeHash + channelLink + afterCursor;
            
            // Set cursor position after the inserted link
            const newCursorPos = beforeHash.length + channelLink.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            hideChannelSuggestions();
        }

        function hideChannelSuggestions() {
            if (currentAutocomplete) {
                currentAutocomplete.container.remove();
                currentAutocomplete = null;
            }
        }

        // Logo management functions
        function handleLogoUpload() {
            const fileInput = document.getElementById('logoFile');
            const urlInput = document.getElementById('serverLogoUrl');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Validate file size (8MB max)
                if (file.size > 8 * 1024 * 1024) {
                    showAlert('File size must be less than 8MB', 'error');
                    return;
                }
                
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    showAlert('Please select a valid image file', 'error');
                    return;
                }
                
                // Convert to base64 and set as URL
                const reader = new FileReader();
                reader.onload = function(e) {
                    urlInput.value = e.target.result;
                    showAlert('Logo ready to save!', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        async function loadCurrentLogo() {
            try {
                const response = await fetch('/api/server-logo');
                const data = await response.json();
                
                const container = document.getElementById('currentLogo');
                if (data.success && data.logo_url) {
                    container.innerHTML = `
                        <h4>Current Server Logo:</h4>
                        <div style="text-align: center; margin: 15px 0;">
                            <img src="${data.logo_url}" alt="Server Logo" style="max-width: 200px; max-height: 200px; border-radius: 10px; border: 2px solid var(--border-color);">
                        </div>
                        <button class="btn btn-danger" onclick="removeLogo()" style="width: 100%;">Remove Logo</button>
                    `;
                } else {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No logo set</p>';
                }
            } catch (error) {
                console.error('Error loading logo:', error);
                document.getElementById('currentLogo').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Error loading logo</p>';
            }
        }

        async function removeLogo() {
            try {
                const response = await fetch('/api/server-logo', {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Logo removed successfully!', 'success');
                    loadCurrentLogo();
                } else {
                    showAlert('Error removing logo: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error removing logo: ' + error.message, 'error');
            }
        }

        // Logo form submission
        document.getElementById('logoForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const logoUrl = document.getElementById('serverLogoUrl').value.trim();
            
            if (!logoUrl) {
                showAlert('Please enter a logo URL or upload a file', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/server-logo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ logo_url: logoUrl })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Logo saved successfully!', 'success');
                    loadCurrentLogo();
                    document.getElementById('logoForm').reset();
                } else {
                    showAlert('Error saving logo: ' + data.message, 'error');
                }
            } catch (error) {
                showAlert('Error saving logo: ' + error.message, 'error');
            }
        });
        
            // Load initial data
            loadTheme();
            loadStatus();
            loadServerData();
            loadCampaigns();
            loadRoleDMs();
            loadGetNowButtons();
            loadLeads();
            loadLoggingChannels();
            loadCurrentLogo();
            loadChannels();
        
        // Add initial role DM entry with delay
        setTimeout(() => {
            addRoleDMEntry();
        }, 1000);

        // Setup autocomplete for all textareas
        setTimeout(async () => {
            await loadChannels(); // Ensure channels are loaded first
            setupAllTextareaAutocomplete();
        }, 1500);

        function setupAllTextareaAutocomplete() {
            // Setup autocomplete for existing textareas
            const textareas = document.querySelectorAll('textarea');
            console.log('Found textareas:', textareas.length);
            textareas.forEach(textarea => {
                setupChannelAutocomplete(textarea);
            });
            
            // Add a test function to window for debugging
            window.testChannelSuggestions = function() {
                console.log('Testing channel suggestions...');
                console.log('Channels available:', channels.length);
                const testTextarea = document.querySelector('#dmMessage') || document.querySelector('.roleMessage');
                if (testTextarea) {
                    testTextarea.value = '#';
                    testTextarea.dispatchEvent(new Event('input'));
                } else {
                    console.log('No textarea found for testing');
                }
            };

            // Setup autocomplete for dynamically added textareas
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1) { // Element node
                            const newTextareas = node.querySelectorAll ? node.querySelectorAll('textarea') : [];
                            newTextareas.forEach(textarea => {
                                setupChannelAutocomplete(textarea);
                            });
                        }
                    });
                });
            });

            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        }

        // Bot Personalizer Functions
        function switchPersonalizerTab(tabName) {
            // Hide all personalizer tab panels
            document.querySelectorAll('.personalizer-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            event.target.classList.add('active');
            
            // Handle tab content switching
            if (tabName === 'basics') {
                // Basics tab is already visible
                console.log('Switched to Basics tab');
            } else if (tabName === 'backstory') {
                // Future: Add backstory functionality
                console.log('Switched to Backstory tab');
                alert('Backstory feature coming soon!');
            }
        }

        function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'image/webp'];
                if (!allowedTypes.includes(file.type)) {
                    alert('Invalid file type. Please use PNG, JPG, JPEG, GIF, or WEBP.');
                    return;
                }
                
                // Validate file size (8MB limit)
                if (file.size > 8 * 1024 * 1024) {
                    alert('File too large. Maximum size is 8MB.');
                    return;
                }
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const avatarImage = document.getElementById('avatarImage');
                    const avatarPlaceholder = document.getElementById('avatarPlaceholder');
                    const previewAvatar = document.getElementById('previewAvatar');
                    
                    // Update main avatar preview
                    avatarImage.src = e.target.result;
                    avatarImage.style.display = 'block';
                    avatarPlaceholder.style.display = 'none';
                    
                    // Update preview panel
                    previewAvatar.innerHTML = `<img src="${e.target.result}" alt="Bot Avatar" style="width: 100%; height: 100%; object-fit: cover;">`;
                };
                reader.readAsDataURL(file);
                
                // Upload avatar to server
                uploadAvatar(file);
            }
        }

        function uploadAvatar(file) {
            const formData = new FormData();
            formData.append('avatar', file);
            
            // Show loading state
            const uploadBtn = document.querySelector('.update-avatar-btn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<span class="upload-icon">‚è≥</span> Uploading...';
            uploadBtn.disabled = true;
            
            fetch('/api/bot-avatar', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bot avatar updated successfully!');
                } else {
                    alert('Error updating avatar: ' + (data.error || 'Unknown error'));
                }
                })
                .catch(error => {
                console.error('Error:', error);
                alert('Error updating avatar: ' + error.message);
            })
            .finally(() => {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
        }

        function updateBotPreview() {
            const botName = document.getElementById('botName').value;
            const botStatus = document.getElementById('botStatus').value;
            const activityType = document.getElementById('activityType').value;
            const activityText = document.getElementById('activityText').value;
            
            // Update preview name
            document.getElementById('previewName').textContent = botName || 'Bot Name';
            
            // Update preview status
            const previewStatus = document.getElementById('previewStatus');
            previewStatus.className = 'preview-status ' + botStatus;
            
            // Update preview activity
            const activityTexts = {
                'watching': 'Watching',
                'playing': 'Playing',
                'listening': 'Listening to',
                'streaming': 'Streaming'
            };
            const activityPrefix = activityTexts[activityType] || 'Watching';
            document.getElementById('previewActivity').textContent = `${activityPrefix} ${activityText || 'Activity'}`;
        }

        function saveBotCustomization() {
            const botName = document.getElementById('botName').value;
            const botStatus = document.getElementById('botStatus').value;
            const activityType = document.getElementById('activityType').value;
            const activityText = document.getElementById('activityText').value;
            const isActive = document.getElementById('botActiveToggle').checked;
            
            // Validate inputs
            if (!botName.trim()) {
                alert('Please enter a bot name');
                return;
            }
            
            if (!activityText.trim()) {
                alert('Please enter activity text');
                return;
            }
            
            // Prepare data
            const botData = {
                name: botName,
                status: botStatus,
                activity_type: activityType,
                activity_text: activityText,
                active: isActive
            };
            
            // Show loading state
            const saveBtn = document.querySelector('.save-changes-btn');
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'Saving...';
            saveBtn.disabled = true;
            
            // Send to backend
            fetch('/api/bot-customize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(botData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bot customization saved successfully!');
                    updateBotPreview();
                } else {
                    alert('Error saving bot customization: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving bot customization: ' + error.message);
            })
            .finally(() => {
                saveBtn.textContent = originalText;
                saveBtn.disabled = false;
            });
        }

        // Add event listeners for real-time preview updates
        document.addEventListener('DOMContentLoaded', function() {
            const botName = document.getElementById('botName');
            const botStatus = document.getElementById('botStatus');
            const activityType = document.getElementById('activityType');
            const activityText = document.getElementById('activityText');
            
            if (botName) {
                botName.addEventListener('input', updateBotPreview);
                botStatus.addEventListener('change', updateBotPreview);
                activityType.addEventListener('change', updateBotPreview);
                activityText.addEventListener('input', updateBotPreview);
                
                // Load current bot customization settings
                loadBotCustomization();
                
                // Load roles for Quick DM
                loadQuickDMRoles();
            }
        });

        function loadBotCustomization() {
            fetch('/api/bot-customize')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.customization) {
                        const custom = data.customization;
                        
                        // Update form fields
                        document.getElementById('botName').value = custom.name || '';
                        document.getElementById('botStatus').value = custom.status || 'online';
                        document.getElementById('activityType').value = custom.activity_type || 'watching';
                        document.getElementById('activityText').value = custom.activity_text || '';
                        document.getElementById('botActiveToggle').checked = custom.active !== false;
                        
                        // Update preview
                        updateBotPreview();
                    }
                })
                .catch(error => {
                    console.error('Error loading bot customization:', error);
                });
        }

        // Quick DM Functions
        function sendQuickDM() {
            const roleId = document.getElementById('quickDMRole').value;
            const title = document.getElementById('quickDMTitle').value;
            const message = document.getElementById('quickDMMessage').value;
            const includeLogo = document.getElementById('quickDMIncludeLogo').checked;
            
            // Validate inputs
            if (!roleId) {
                alert('Please select a role to DM');
                return;
            }
            
            if (!message.trim()) {
                alert('Please enter a message');
                return;
            }
            
            // Confirm before sending
            const roleName = document.getElementById('quickDMRole').selectedOptions[0].text;
            if (!confirm(`Are you sure you want to send this message to ALL members with the "${roleName}" role?`)) {
                return;
            }
            
            // Show status and hide results
            document.getElementById('quickDMStatus').style.display = 'block';
            document.getElementById('quickDMResults').style.display = 'none';
            
            // Prepare data
            const data = {
                role_id: roleId,
                title: title,
                message: message,
                include_logo: includeLogo
            };
            
            // Send request
            fetch('/api/quick-dm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                // Hide status
                document.getElementById('quickDMStatus').style.display = 'none';
                
                if (result.success) {
                    // Show results
                    showQuickDMResults(result);
                    showAlert('Quick DM sent successfully!', 'success');
                } else {
                    showAlert('Error sending Quick DM: ' + (result.error || result.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('quickDMStatus').style.display = 'none';
                alert('Error sending Quick DM: ' + error.message);
            });
        }

        function previewQuickDM() {
            const title = document.getElementById('quickDMTitle').value;
            const message = document.getElementById('quickDMMessage').value;
            const includeLogo = document.getElementById('quickDMIncludeLogo').checked;
            
            if (!message.trim()) {
                alert('Please enter a message to preview');
                return;
            }
            
            // Create preview content
            let previewContent = '';
            
            if (title) {
                previewContent += `**${title}**\n\n`;
            }
            
            previewContent += message;
            
            if (includeLogo) {
                previewContent += '\n\n*[Server logo will be included]*';
            }
            
            // Show preview in modal or alert
            const preview = `
üìß **Message Preview**

${previewContent}

---
*This is how your message will appear to recipients*
            `;
            
            alert(preview);
        }

        function showQuickDMResults(result) {
            document.getElementById('successCount').textContent = result.success_count || 0;
            document.getElementById('errorCount').textContent = result.error_count || 0;
            document.getElementById('skippedCount').textContent = result.skipped_count || 0;
            document.getElementById('dmDisabledCount').textContent = result.dm_disabled_count || 0;
            document.getElementById('totalCount').textContent = result.total_count || 0;
            
            document.getElementById('quickDMResults').style.display = 'block';
        }

        function closeQuickDMResults() {
            document.getElementById('quickDMResults').style.display = 'none';
        }
        
        // Test DM Permissions
        async function testDMPermissions() {
            const roleId = document.getElementById('quickDMRole').value;
            
            if (!roleId) {
                alert('Please select a role first');
                return;
            }
            
            try {
                const response = await fetch('/api/test-dm-permissions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ role_id: roleId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    let message = `DM Permission Test Results for "${data.role_name}":\n\n`;
                    message += `Total members: ${data.total_members}\n\n`;
                    
                    data.test_results.forEach(result => {
                        message += `${result.username}: ${result.status}\n`;
                    });
                    
                    message += `\nüí° If users have DMs disabled, they need to:\n`;
                    message += `1. Go to User Settings ‚Üí Privacy & Safety\n`;
                    message += `2. Enable "Allow direct messages from server members"`;
                    
                    alert(message);
                } else {
                    alert('Error testing DM permissions: ' + data.error);
                }
            } catch (error) {
                alert('Error testing DM permissions: ' + error.message);
            }
        }

        // Load roles for Quick DM dropdown
        function loadQuickDMRoles() {
            fetch('/api/roles')
                .then(response => response.json())
                .then(roles => {
                    const select = document.getElementById('quickDMRole');
                    select.innerHTML = '<option value="">Select a role to DM...</option>';
                    
                    roles.forEach(role => {
                        const option = document.createElement('option');
                        option.value = role.id;
                        option.textContent = role.name;
                        select.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error loading roles for Quick DM:', error);
                });
        }

        // AI Analytics Functions
        function refreshAnalytics() {
            fetch('/api/analytics/overview')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateAnalyticsDisplay(data.analytics);
                    } else {
                        console.error('Error loading analytics:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading analytics:', error);
                });
        }

        function updateAnalyticsDisplay(analytics) {
            // Update overview stats
                document.getElementById('totalInteractions').textContent = analytics.total_interactions || 0;
                document.getElementById('uniqueUsers').textContent = analytics.unique_users || 0;
                
                if (analytics.interaction_breakdown && analytics.interaction_breakdown.length > 0) {
                    document.getElementById('topInteraction').textContent = analytics.interaction_breakdown[0].type;
                }
                
                // Update top links
                const topLinksList = document.getElementById('topLinksList');
                if (analytics.top_links && analytics.top_links.length > 0) {
                    topLinksList.innerHTML = analytics.top_links.map(link => `
                        <div class="analytics-item">
                            <div class="analytics-item-info">
                                <div class="analytics-item-title">${link.url.length > 50 ? link.url.substring(0, 50) + '...' : link.url}</div>
                                <div class="analytics-item-url">Last clicked: ${new Date(link.last_clicked).toLocaleString()}</div>
                            </div>
                            <div class="analytics-item-stats">
                                <div class="analytics-item-count">${link.clicks}</div>
                                <div class="analytics-item-unique">${link.unique_clicks} unique</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                topLinksList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No link clicks recorded</p>';
                }
                
                // Update top buttons
                const topButtonsList = document.getElementById('topButtonsList');
                if (analytics.top_buttons && analytics.top_buttons.length > 0) {
                    topButtonsList.innerHTML = analytics.top_buttons.map(button => `
                        <div class="analytics-item">
                            <div class="analytics-item-info">
                                <div class="analytics-item-title">${button.text || button.id}</div>
                                <div class="analytics-item-url">Last clicked: ${new Date(button.last_clicked).toLocaleString()}</div>
                            </div>
                            <div class="analytics-item-stats">
                                <div class="analytics-item-count">${button.clicks}</div>
                                <div class="analytics-item-unique">${button.unique_clicks} unique</div>
                            </div>
                        </div>
                    `).join('');
                } else {
                topButtonsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No button clicks recorded</p>';
            }
            
            // Update recent activity
            const recentActivity = document.getElementById('recentActivity');
            if (analytics.recent_activity && analytics.recent_activity.length > 0) {
                recentActivity.innerHTML = analytics.recent_activity.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${getActivityIcon(activity.type)}</div>
                        <div class="activity-content">
                            <div class="activity-user">${activity.user || 'Unknown User'}</div>
                            <div class="activity-action">${activity.type.replace('_', ' ')}</div>
                        </div>
                        <div class="activity-time">${new Date(activity.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            } else {
                recentActivity.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No recent activity</p>';
            }
        }

        function getActivityIcon(activityType) {
            const icons = {
                'link_click': 'üîó',
                'button_click': 'üîò',
                'page_view': 'üëÅÔ∏è',
                'dm_sent': 'üìß',
                'role_assigned': 'üé≠',
                'campaign_started': 'üì¢'
            };
            return icons[activityType] || 'üìä';
        }

        function generateInsights() {
            const insightsContainer = document.getElementById('aiInsights');
            insightsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Generating AI insights...</p>';
            
            fetch('/api/analytics/insights')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.insights) {
                        insightsContainer.innerHTML = data.insights.map(insight => `
                    <div class="insight-item">
                                <div class="insight-type">${insight.type.replace('_', ' ').toUpperCase()}</div>
                                <div class="insight-data">${insight.data}</div>
                                <div class="insight-confidence">Confidence: ${Math.round(insight.confidence * 100)}%</div>
                    </div>
                        `).join('');
                    } else {
                        insightsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No insights available</p>';
                    }
                })
                .catch(error => {
                    console.error('Error generating insights:', error);
                    insightsContainer.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Error generating insights</p>';
                });
        }

        function exportAnalytics() {
            fetch('/api/analytics/export')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create and download CSV file
                        const blob = new Blob([data.csv_data], { type: 'text/csv' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = data.filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        alert('Analytics data exported successfully!');
                    } else {
                        alert('Error exporting data: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error exporting analytics:', error);
                    alert('Error exporting data: ' + error.message);
                });
        }

        function clearAnalytics() {
            if (confirm('Are you sure you want to clear all analytics data? This action cannot be undone.')) {
                // Clear dashboard user data and reset analytics
                fetch('/api/clear-analytics', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Analytics data cleared successfully!');
                        refreshAnalytics();
                    } else {
                        alert('Error clearing analytics: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error clearing analytics:', error);
                    alert('Error clearing analytics data');
                });
            }
        }

        // AI Tracking Settings
        let aiTrackingEnabled = localStorage.getItem('ai_tracking_enabled') === 'true';
        
        // Toggle AI tracking
        function toggleAITracking() {
            aiTrackingEnabled = !aiTrackingEnabled;
            localStorage.setItem('ai_tracking_enabled', aiTrackingEnabled);
            updateAITrackingUI();
            
            if (aiTrackingEnabled) {
                alert('AI Tracking: ENABLED - Will track custom links and buttons only');
            } else {
                alert('AI Tracking: DISABLED - No tracking will occur');
            }
        }
        
        function updateAITrackingUI() {
            const toggleBtn = document.getElementById('aiToggleBtn');
            const statusText = document.getElementById('aiStatusText');
            
            if (toggleBtn && statusText) {
                if (aiTrackingEnabled) {
                    toggleBtn.textContent = 'Disable AI Tracking';
                    toggleBtn.className = 'btn btn-danger';
                    statusText.textContent = 'AI Tracking: ENABLED';
                    statusText.style.color = '#10b981';
                } else {
                    toggleBtn.textContent = 'Enable AI Tracking';
                    toggleBtn.className = 'btn btn-success';
                    statusText.textContent = 'AI Tracking: DISABLED';
                    statusText.style.color = '#ef4444';
                }
            }
        }
        
        // Track interactions automatically (only if AI tracking is enabled)
        function trackInteraction(interactionType, interactionData = {}) {
            if (!aiTrackingEnabled) return;
            
            // Only track specific interaction types (not dashboard interactions)
            const allowedTypes = ['custom_link_click', 'get_now_button_click', 'role_dm_interaction', 'marketing_campaign_click'];
            if (!allowedTypes.includes(interactionType)) return;
            
            const userId = 'user_' + Math.random().toString(36).substr(2, 9);
            const sessionId = sessionStorage.getItem('session_id') || (sessionStorage.setItem('session_id', Math.random().toString(36).substr(2, 9)), sessionStorage.getItem('session_id'));
                
                fetch('/api/track-interaction', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: userId,
                    user_name: 'Discord User',
                        interaction_type: interactionType,
                        interaction_data: interactionData,
                        session_id: sessionId
                    })
                }).catch(error => {
                    console.error('Error tracking interaction:', error);
                });
        }

        // Opt-Out Management Functions
        async function loadOptOuts() {
            try {
                const response = await fetch('/api/opt-outs');
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('totalOptOuts').textContent = data.total_opt_outs;
                    document.getElementById('recentOptOuts').textContent = data.recent_opt_outs;
                    
                    const optOutsList = document.getElementById('optOutsList');
                    if (data.recent_list.length === 0) {
                        optOutsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No opt-outs found</p>';
                    } else {
                        optOutsList.innerHTML = data.recent_list.map(optOut => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border-color);">
                                <div>
                                    <strong>${optOut.username}</strong>
                                    <small style="color: var(--text-secondary); display: block;">${new Date(optOut.date).toLocaleString()}</small>
                                </div>
                                <span style="color: #ef4444; font-size: 12px;">OPTED OUT</span>
                            </div>
                        `).join('');
                    }
                } else {
                    console.error('Error loading opt-outs:', data.error);
                }
            } catch (error) {
                console.error('Error loading opt-outs:', error);
            }
        }
        
        function exportOptOuts() {
            alert('Export opt-outs functionality would be implemented here');
        }
        
        // Dev Debug Functions
        function toggleDebugLogging() {
            const enabled = document.getElementById('enableDebugLogging').checked;
            localStorage.setItem('debug_logging', enabled);
            console.log('Debug logging:', enabled ? 'ENABLED' : 'DISABLED');
        }
        
        function toggleVerboseErrors() {
            const enabled = document.getElementById('enableVerboseErrors').checked;
            localStorage.setItem('verbose_errors', enabled);
            console.log('Verbose errors:', enabled ? 'ENABLED' : 'DISABLED');
        }
        
        function toggleRateLimitBypass() {
            const enabled = document.getElementById('enableRateLimitBypass').checked;
            localStorage.setItem('rate_limit_bypass', enabled);
            console.log('Rate limit bypass:', enabled ? 'ENABLED' : 'DISABLED');
        }
        
        async function testBotConnection() {
            const debugResults = document.getElementById('debugResults');
            const debugResultsContent = document.getElementById('debugResultsContent');
            
            debugResults.style.display = 'block';
            debugResultsContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Testing bot connection...</p>';
            
            try {
                const response = await fetch('/api/status');
                const data = await response.json();
                
                let html = '<div style="display: grid; gap: 10px;">';
                
                // Bot Status
                const botStatus = data.running ? 'ONLINE' : 'OFFLINE';
                const statusColor = data.running ? '#10b981' : '#ef4444';
                html += `<div style="padding: 10px; background: ${statusColor}; border-radius: 8px; color: white;">
                    <strong>ü§ñ Bot Status:</strong> ${botStatus}
                </div>`;
                
                // Guilds
                html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong>üè† Guilds Connected:</strong> ${data.guilds ? data.guilds.length : 0}
                </div>`;
                
                // Commands
                html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong>‚ö° Commands:</strong> ${data.commands ? data.commands.length : 0}
                </div>`;
                
                // Last Sync
                if (data.last_sync) {
                    const syncDate = new Date(data.last_sync * 1000);
                    html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                        <strong>üîÑ Last Sync:</strong> ${syncDate.toLocaleString()}
                    </div>`;
                }
                
                html += '</div>';
                debugResultsContent.innerHTML = html;
                
            } catch (error) {
                debugResultsContent.innerHTML = `<p style="color: #ef4444; text-align: center;">Connection test failed: ${error.message}</p>`;
            }
        }
        
        async function checkBotPermissions() {
            const debugResults = document.getElementById('debugResults');
            const debugResultsContent = document.getElementById('debugResultsContent');
            
            debugResults.style.display = 'block';
            debugResultsContent.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Checking bot permissions...</p>';
            
            try {
                const response = await fetch('/api/roles');
                const roles = await response.json();
                
                const response2 = await fetch('/api/channels');
                const channels = await response2.json();
                
                let html = '<div style="display: grid; gap: 10px;">';
                
                html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong>üé≠ Available Roles:</strong> ${roles.length}
                </div>`;
                
                html += `<div style="padding: 10px; background: var(--bg-tertiary); border-radius: 8px;">
                    <strong>üì∫ Available Channels:</strong> ${channels.length}
                </div>`;
                
                if (roles.length === 0) {
                    html += `<div style="padding: 10px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                        <strong>‚ö†Ô∏è Warning:</strong> No roles found. Bot may lack permissions.
                    </div>`;
                }
                
                if (channels.length === 0) {
                    html += `<div style="padding: 10px; background: #fef3c7; border-radius: 8px; color: #92400e;">
                        <strong>‚ö†Ô∏è Warning:</strong> No channels found. Bot may lack permissions.
                    </div>`;
                }
                
                html += '</div>';
                debugResultsContent.innerHTML = html;
                
            } catch (error) {
                debugResultsContent.innerHTML = `<p style="color: #ef4444; text-align: center;">Permission check failed: ${error.message}</p>`;
            }
        }
        
        function clearBotCache() {
            if (confirm('Are you sure you want to clear the bot cache? This will restart the bot.')) {
                fetch('/api/clear-cache', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Bot cache cleared successfully! The bot will restart.');
                            setTimeout(() => {
                                window.location.reload();
                            }, 2000);
                        } else {
                            alert('Failed to clear cache: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error clearing cache: ' + error.message);
                    });
            }
        }
        
        // Emoji Picker Functions
        function openEmojiPicker(inputId) {
            const input = document.getElementById(inputId);
            const picker = input.parentElement.querySelector('.emoji-picker-container');
            
            if (picker.style.display === 'block') {
                picker.style.display = 'none';
            } else {
                picker.style.display = 'block';
                loadEmojiPicker(inputId);
            }
        }
        
        function switchEmojiTab(tab) {
            const unicodeTab = document.querySelector('.emoji-tab[onclick*="unicode"]');
            const serverTab = document.querySelector('.emoji-tab[onclick*="server"]');
            const unicodeGrid = document.querySelector('.unicode-emojis');
            const serverGrid = document.querySelector('.server-emojis');
            
            if (tab === 'unicode') {
                unicodeTab.classList.add('active');
                serverTab.classList.remove('active');
                unicodeGrid.style.display = 'grid';
                serverGrid.style.display = 'none';
            } else {
                serverTab.classList.add('active');
                unicodeTab.classList.remove('active');
                unicodeGrid.style.display = 'none';
                serverGrid.style.display = 'grid';
                loadServerEmojis();
            }
        }
        
        function loadEmojiPicker(inputId) {
            const unicodeGrid = document.querySelector('.unicode-emojis');
            const serverGrid = document.querySelector('.server-emojis');
            
            // Load Unicode emojis
            const unicodeEmojis = ['üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá', 'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë', 'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨', 'ü§•', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ', 'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üéØ', 'üé™', 'üé®', 'üé≠', 'üé™', 'üé´', 'üé¨', 'üéÆ', 'üïπÔ∏è', 'üé∞', 'üé≤', 'üß©', 'üéØ', 'üé≥', 'üé¥', 'üéµ', 'üé∂', 'üé∏', 'üéπ', 'üé∫', 'üéª', 'ü•Å', 'üé§', 'üéß', 'üìª', 'üì∫', 'üì∑', 'üìπ', 'üìº', 'üîç', 'üîé', 'üî¨', 'üî≠', 'üì°', 'üíª', 'üñ•Ô∏è', 'üñ®Ô∏è', '‚å®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üíΩ', 'üíæ', 'üíø', 'üìÄ', 'üßÆ', 'üéÅ', 'üéÄ', 'üéÇ', 'üéà', 'üéâ', 'üéä', 'üéã', 'üéç', 'üéé', 'üéè', 'üéê', 'üéë', 'üßß', 'üéÄ', 'üéÅ', 'üéÇ', 'üéÉ', 'üéÑ', 'üéÖ', 'ü§∂', 'üßë‚ÄçüéÑ', 'üéÜ', 'üéá', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üéã', 'üéç', 'üéé', 'üéè', 'üéê', 'üéë', 'üßß', 'üéÄ', 'üéÅ', 'üéÇ', 'üéÉ', 'üéÑ', 'üéÖ', 'ü§∂', 'üßë‚ÄçüéÑ', 'üéÜ', 'üéá', '‚ú®', 'üéà', 'üéâ', 'üéä', 'üéã', 'üéç', 'üéé', 'üéè', 'üéê', 'üéë', 'üßß'];
            
            unicodeGrid.innerHTML = '';
            unicodeEmojis.forEach(emoji => {
                const emojiBtn = document.createElement('button');
                emojiBtn.type = 'button';
                emojiBtn.className = 'emoji-btn';
                emojiBtn.textContent = emoji;
                emojiBtn.onclick = () => selectEmoji(inputId, emoji);
                unicodeGrid.appendChild(emojiBtn);
            });
            
            // Load server emojis
            loadServerEmojis();
        }
        
        function loadServerEmojis() {
            const serverGrid = document.querySelector('.server-emojis');
            serverGrid.innerHTML = '';
            
            if (window.serverEmojis && window.serverEmojis.length > 0) {
                window.serverEmojis.forEach(emoji => {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.type = 'button';
                    emojiBtn.className = 'emoji-btn server-emoji-btn';
                    emojiBtn.innerHTML = `<img src="${emoji.url}" alt="${emoji.name}" style="width: 20px; height: 20px;">`;
                    emojiBtn.onclick = () => selectEmoji('roleDMButtonEmojiInput', emoji.display);
                    serverGrid.appendChild(emojiBtn);
                });
            } else {
                serverGrid.innerHTML = '<p style="color: var(--text-secondary); text-align: center; grid-column: 1 / -1;">No server emojis available</p>';
            }
        }
        
        function selectEmoji(inputId, emoji) {
            const input = document.getElementById(inputId);
            input.value = emoji;
            
            // Close picker
            const picker = input.parentElement.querySelector('.emoji-picker-container');
            picker.style.display = 'none';
        }
        
        // Role DM form submission
        document.getElementById('setdmForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const roleName = document.getElementById('roleName').value;
            const title = document.getElementById('dmTitle').value;
            const message = document.getElementById('dmMessage').value;
            const claim = document.getElementById('claimButton').checked;
            const claimRole = document.getElementById('roleDMClaimRole').value;
            const buttonText = document.getElementById('roleDMButtonText').value || 'Claim Rewards';
            const buttonColor = document.getElementById('roleDMButtonColorInput').value || 'success';
            const buttonEmoji = document.getElementById('roleDMButtonEmojiInput').value || 'üéÅ';
            const includeServerLogo = document.getElementById('includeServerLogo').checked;
            
            if (!roleName) {
                showAlert('Please select a role', 'error');
                return;
            }
            
            if (!message.trim()) {
                showAlert('Please enter a message', 'error');
                return;
            }
            
            if (claim && !claimRole) {
                showAlert('Please select a role to claim when claim button is enabled', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/setdm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        role_name: roleName, 
                        title: title,
                        message: message, 
                        claim: claim, 
                        claim_role: claimRole,
                        button_text: buttonText,
                        button_color: buttonColor,
                        button_emoji: buttonEmoji,
                        include_server_logo: includeServerLogo
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Role DM set successfully!', 'success');
                    document.getElementById('setdmForm').reset();
                    loadRoleDMs();
                } else {
                    showAlert('Error: ' + (data.error || data.message || 'Unknown error'), 'error');
                }
            } catch (error) {
                showAlert('Error setting role DM: ' + error.message, 'error');
            }
        });

        // Load opt-outs
        async function loadOptOuts() {
            try {
                const response = await fetch('/api/optouts');
                const data = await response.json();
                
                if (data.success) {
                    // Update statistics
                    document.getElementById('totalOptOuts').textContent = data.total_optouts;
                    document.getElementById('thisWeekOptOuts').textContent = data.this_week_optouts;
                    
                    // Update opt-out list
                    const optOutsList = document.getElementById('optOutsList');
                    if (data.optouts.length === 0) {
                        optOutsList.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">No opt-outs found</p>';
                    } else {
                        optOutsList.innerHTML = data.optouts.map(optout => `
                            <div class="optout-item">
                                <div class="optout-info">
                                    <div class="optout-username">${optout.username}</div>
                                    <div class="optout-date">${new Date(optout.created_at).toLocaleString()}</div>
                                </div>
                                <div class="optout-actions">
                                    <button class="btn btn-warning" onclick="removeOptOut('${optout.user_id}')">Remove</button>
                                </div>
                            </div>
                        `).join('');
                    }
                } else {
                    console.error('Error loading opt-outs:', data.error);
                }
            } catch (error) {
                console.error('Error loading opt-outs:', error);
            }
        }
        
        // Export opt-outs
        async function exportOptOuts() {
            try {
                const response = await fetch('/api/optouts/export');
                const data = await response.json();
                
                if (data.success) {
                    // Create and download CSV file
                    const blob = new Blob([data.csv_data], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = data.filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showAlert('Opt-out data exported successfully!', 'success');
                } else {
                    showAlert('Error exporting opt-outs: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error exporting opt-outs: ' + error.message, 'error');
            }
        }
        
        // Remove opt-out
        async function removeOptOut(userId) {
            if (!confirm('Are you sure you want to remove this opt-out?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/optouts/${userId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    showAlert('Opt-out removed successfully!', 'success');
                    loadOptOuts();
                } else {
                    showAlert('Error removing opt-out: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Error removing opt-out: ' + error.message, 'error');
            }
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded - AI tracking can be toggled on/off');
            
            // Initialize AI tracking UI
            updateAITrackingUI();
            
            // Load opt-outs on page load
            loadOptOuts();
            
            // No automatic tracking of dashboard interactions
            // Only track custom links and buttons when AI tracking is enabled
        });
    </script>
</body>
</html>
